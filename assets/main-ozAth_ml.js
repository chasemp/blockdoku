const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./sound-manager-3Z7j5x4c.js","./sound-manager-CEWoWtIg.css"])))=>i.map(i=>d[i]);
import"./wood-B4vXo_re.js";import{C as G,S as $,G as O,P as H}from"./sound-manager-3Z7j5x4c.js";const q="modulepreload",F=function(g,e){return new URL(g,e).href},L={},z=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){const a=document.getElementsByTagName("link"),l=document.querySelector("meta[property=csp-nonce]"),n=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(t.map(r=>{if(r=F(r,s),r in L)return;L[r]=!0;const c=r.endsWith(".css"),h=c?'[rel="stylesheet"]':"";if(!!s)for(let u=a.length-1;u>=0;u--){const f=a[u];if(f.href===r&&(!c||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${r}"]${h}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":q,c||(m.as="script"),m.crossOrigin="",m.href=r,n&&m.setAttribute("nonce",n),document.head.appendChild(m),c)return new Promise((u,f)=>{m.addEventListener("load",u),m.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${r}`)))})}))}function o(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return i.then(a=>{for(const l of a||[])l.status==="rejected"&&o(l.reason);return e().catch(o)})};class N{constructor(){this.blockShapes=this.defineBlockShapes(),this.currentBlocks=[],this.selectedBlock=null,this.selectedBlockPosition=null}defineBlockShapes(){return{single:{name:"Single",shape:[[1]],color:"#007bff",points:1},line2:{name:"Line 2",shape:[[1,1]],color:"#28a745",points:2},line3:{name:"Line 3",shape:[[1,1,1]],color:"#28a745",points:3},l2x2:{name:"L 2x2",shape:[[1,0],[1,1]],color:"#dc3545",points:3},l3x2:{name:"L 3x2",shape:[[1,0],[1,0],[1,1]],color:"#dc3545",points:4},t3x2:{name:"T 3x2",shape:[[1,1,1],[0,1,0]],color:"#ffc107",points:4},square2x2:{name:"Square 2x2",shape:[[1,1],[1,1]],color:"#6f42c1",points:4},z3x2:{name:"Z 3x2",shape:[[1,1,0],[0,1,1]],color:"#fd7e14",points:4}}}generateRandomBlocks(e=3,t="all",s=null){let i=Object.keys(this.blockShapes);if(s){const o=s.getAllowedShapes(),a=s.getBlockSizeRange();o!=="all"&&(i=i.filter(l=>o.includes(l))),i=i.filter(l=>{const n=this.blockShapes[l].shape,r=Math.max(n.length,n[0].length);return r>=a[0]&&r<=a[1]})}else t==="large"?i=i.filter(o=>{const a=this.blockShapes[o].shape;return Math.max(a.length,a[0].length)>=3}):t==="small"?i=i.filter(o=>{const a=this.blockShapes[o].shape;return Math.max(a.length,a[0].length)<=3}):t==="complex"&&(i=i.filter(o=>(this.blockShapes[o].shape,o.includes("L")||o.includes("T")||o.includes("Z")||o.includes("U")||o.includes("Cross")||o.includes("Plus"))));i.length===0&&(i=Object.keys(this.blockShapes)),this.currentBlocks=[];for(let o=0;o<e;o++){const a=i[Math.floor(Math.random()*i.length)],l={...this.blockShapes[a],id:`block_${o}_${Date.now()}`,rotation:0};this.currentBlocks.push(l)}return this.currentBlocks}rotateBlock(e){return e?{...e,shape:this.rotateMatrix(e.shape),rotation:(e.rotation+90)%360}:null}rotateMatrix(e){const t=e.length,s=e[0].length,i=[];for(let o=0;o<s;o++){i[o]=[];for(let a=0;a<t;a++)i[o][a]=e[t-1-a][o]}return i}canPlaceBlock(e,t,s,i){if(!e||!i||!Array.isArray(i)||i.length===0)return console.warn("canPlaceBlock: Invalid inputs",{block:e,board:i}),!1;const o=e.shape;if(!o||!Array.isArray(o)||o.length===0)return console.warn("canPlaceBlock: Invalid block shape",{block:e,shape:o}),!1;const a=i.length;if(t<0||s<0||t+o.length>a||s+o[0].length>a)return!1;for(let l=0;l<o.length;l++)for(let n=0;n<o[l].length;n++)if(o[l][n]===1&&(t+l>=a||s+n>=a||!i[t+l]||i[t+l][s+n]===1))return!1;return!0}placeBlock(e,t,s,i){const o=e.shape,a=i.map(l=>[...l]);for(let l=0;l<o.length;l++)for(let n=0;n<o[l].length;n++)o[l][n]===1&&(a[t+l][s+n]=1);return a}removeBlock(e){this.currentBlocks=this.currentBlocks.filter(t=>t.id!==e)}getBlockById(e){return this.currentBlocks.find(t=>t.id===e)}clearSelection(){this.selectedBlock=null,this.selectedBlockPosition=null}}class U{constructor(e,t,s=null){this.container=document.getElementById(e),this.blockManager=t,this.petrificationManager=s,this.selectedBlock=null,this.blockElements=new Map,this._placeabilityTimeout=null,this.lastTapTime=null,this._petrificationUpdateInterval=null,this.pieceTimeouts=new Map,this.timeoutCheckInterval=null,this.WARNING_TIME=15e3,this.TIMEOUT_TIME=3e4,this.onPieceTimeout=null,this.timeoutPaused=!1,this.init()}init(){this.render(),this.setupEventListeners()}render(){this.container&&(this.container.innerHTML=`
            <div class="block-palette">
                <h3>Available Blocks</h3>
                <div class="blocks-container" id="blocks-container">
                    <!-- Blocks will be rendered here -->
                </div>
            </div>
            <button id="rotate-selected" class="rotate-selected-btn" title="Rotate selected block">
                <span>â†»</span>
            </button>
        `)}updateBlocks(e){const t=document.getElementById("blocks-container");t&&(t.innerHTML="",this.blockElements.clear(),e.forEach(s=>{const i=this.createBlockElement(s);t.appendChild(i),this.blockElements.set(s.id,i)}),this.petrificationManager&&this.petrificationManager.isEnabled()?this.startPetrificationUpdates():this.stopPetrificationUpdates(),this.resetPieceTimeouts(e))}createBlockElement(e){const t=document.createElement("div");t.className="block-item",t.dataset.blockId=e.id,t.title=`Click to select, double-click to rotate: ${e.name} (${e.points} pts)`;const s=document.createElement("div");s.className="block-shape";const i=30,o=document.createElement("div");o.className="block-preview",o.style.width=`${e.shape[0].length*i}px`,o.style.height=`${e.shape.length*i}px`;const a=document.createElement("canvas");a.width=e.shape[0].length*i,a.height=e.shape.length*i;const l=a.getContext("2d");l.fillStyle=e.color,l.strokeStyle=this.darkenColor(e.color),l.lineWidth=2;for(let n=0;n<e.shape.length;n++)for(let r=0;r<e.shape[n].length;r++)if(e.shape[n][r]===1){const c=r*i,h=n*i;l.fillRect(c,h,i,i),l.strokeRect(c,h,i,i)}return o.appendChild(a),s.appendChild(o),t.appendChild(s),t}setupEventListeners(){document.addEventListener("click",e=>{if(e.target.closest(".block-item")){const s=e.target.closest(".block-item").dataset.blockId;this.selectBlock(s)}e.target.closest("#rotate-selected")&&(e.preventDefault(),this.selectedBlock&&this.rotateBlock(this.selectedBlock.id))}),document.addEventListener("dblclick",e=>{if(e.target.closest(".block-item")){e.preventDefault();const s=e.target.closest(".block-item").dataset.blockId;this.rotateBlock(s)}}),document.addEventListener("touchstart",e=>{if(e.target.closest(".block-item")){const t=e.target.closest(".block-item"),s=t.dataset.blockId;this.touchStart=e.touches[0],this.touchStartTime=Date.now(),this.touchStartBlockId=s,t.style.transform="scale(0.95)",t.style.transition="transform 0.1s ease"}},{passive:!0}),document.addEventListener("touchmove",e=>{if(this.touchStart&&this.touchStartBlockId){if(!this.blockManager.getBlockById(this.touchStartBlockId)){this.resetDragState();return}const s=e.touches[0],i=Math.abs(s.clientX-this.touchStart.clientX),o=Math.abs(s.clientY-this.touchStart.clientY),a=Date.now()-this.touchStartTime;if((i>5||o>5||a>100)&&(e.preventDefault(),!this.isDragging)){this.isDragging=!0,this.startDragFromPalette(s);const l=document.querySelector(`[data-block-id="${this.touchStartBlockId}"]`);l&&l.classList.add("dragging")}}},{passive:!1}),document.addEventListener("touchend",e=>{if(this.touchStart){const t=this.blockManager.getBlockById(this.touchStartBlockId),s=e.changedTouches[0],i=Date.now()-this.touchStartTime,o=Math.abs(s.clientX-this.touchStart.clientX),a=Math.abs(s.clientY-this.touchStart.clientY);t&&o<5&&a<5&&i<200&&(this.lastTapTime&&Date.now()-this.lastTapTime<300?(e.preventDefault(),this.rotateBlock(this.touchStartBlockId),this.lastTapTime=null):(this.selectBlock(this.touchStartBlockId),this.lastTapTime=Date.now())),this.resetDragState()}},{passive:!1}),document.addEventListener("touchcancel",e=>{this.touchStart&&(this.resetDragState(),this.lastTapTime=null)},{passive:!0})}resetDragState(){if(this.touchStartBlockId){const e=document.querySelector(`[data-block-id="${this.touchStartBlockId}"]`);e&&(e.classList.remove("dragging"),e.style.transform="",e.style.transition="")}this.touchStart=null,this.touchStartTime=null,this.touchStartBlockId=null,this.isDragging=!1}startDragFromPalette(e){const t=this.blockManager.getBlockById(this.touchStartBlockId);if(!t){this.resetDragState();return}this.selectBlock(this.touchStartBlockId);const s=new CustomEvent("blockDragStart",{detail:{block:t,touch:e}});document.dispatchEvent(s)}selectBlock(e){this.clearSelection(),this.selectedBlock=this.blockManager.getBlockById(e),this.selectedBlock,this.updateRotateButton(),this.dispatchSelectionEvent()}selectBlockById(e){this.selectBlock(e)}rotateBlock(e){const t=this.blockManager.getBlockById(e);if(!t)return;const s=this.blockManager.rotateBlock(t);if(s){const i=this.blockManager.currentBlocks.findIndex(o=>o.id===e);i!==-1&&(this.blockManager.currentBlocks[i]=s,this.updateBlocks(this.blockManager.currentBlocks),this.selectedBlock&&this.selectedBlock.id===e&&(this.selectedBlock=s,this.dispatchSelectionEvent()),this.game&&this.game.effectsManager&&this.game.effectsManager.onBlockRotate())}}clearSelection(){this.selectedBlock=null,this.updateRotateButton()}dispatchSelectionEvent(){const e=new CustomEvent("blockSelected",{detail:{block:this.selectedBlock}});document.dispatchEvent(e)}darkenColor(e){const t=e.replace("#",""),s=parseInt(t.substr(0,2),16),i=parseInt(t.substr(2,2),16),o=parseInt(t.substr(4,2),16),a=Math.max(0,s-30),l=Math.max(0,i-30),n=Math.max(0,o-30);return`rgb(${a}, ${l}, ${n})`}updateRotateButton(){const e=document.getElementById("rotate-selected");e&&(this.selectedBlock?(e.disabled=!1,e.classList.remove("disabled")):(e.disabled=!0,e.classList.add("disabled")))}getSelectedBlock(){return this.selectedBlock}setPlaceability(e,t={}){const{highlightLast:s=!1,durationMs:i=1250}=t;this._placeabilityTimeout&&(clearTimeout(this._placeabilityTimeout),this._placeabilityTimeout=null);let o=[];if(Object.keys(e||{}).forEach(a=>{e[a]&&o.push(a)}),this.blockElements.forEach((a,l)=>{const n=!!e[l];a.classList.toggle("unplaceable",!n),a.classList.toggle("placeable",n),a.classList.remove("last-playable")}),s&&o.length===1){const a=o[0],l=this.blockElements.get(a);l&&l.classList.add("last-playable")}i>0&&(this._placeabilityTimeout=setTimeout(()=>{this.clearPlaceability()},i))}showPreGameOverIndicator(e=1250){if(!this.container)return;const t=this.container.querySelector(".block-palette");t&&t.classList.add("pre-game-over"),this.blockElements.forEach(s=>{s.classList.add("unplaceable"),s.classList.remove("last-playable")}),this._placeabilityTimeout&&clearTimeout(this._placeabilityTimeout),e>0&&(this._placeabilityTimeout=setTimeout(()=>{this.clearPlaceability()},e))}clearPlaceability(){const e=this.container?this.container.querySelector(".block-palette"):null;e&&e.classList.remove("pre-game-over"),this.blockElements.forEach(t=>{t.classList.remove("unplaceable"),t.classList.remove("placeable"),t.classList.remove("last-playable")}),this._placeabilityTimeout&&(clearTimeout(this._placeabilityTimeout),this._placeabilityTimeout=null)}startPetrificationUpdates(){this.stopPetrificationUpdates(),this._petrificationUpdateInterval=setInterval(()=>{this.updatePetrificationVisuals()},100)}stopPetrificationUpdates(){this._petrificationUpdateInterval&&(clearInterval(this._petrificationUpdateInterval),this._petrificationUpdateInterval=null),this.blockElements.forEach(e=>{e.classList.remove("petrified","warning-7s","warning-3s")})}updatePetrificationVisuals(){!this.petrificationManager||!this.petrificationManager.isEnabled()||this.blockElements.forEach((e,t)=>{const s=this.petrificationManager.getBlockState(t);e.classList.remove("petrified","warning-7s","warning-3s"),s.petrified?e.classList.add("petrified"):s.warning==="3s"?e.classList.add("warning-3s"):s.warning==="7s"&&e.classList.add("warning-7s")})}resetPieceTimeouts(e){this.pieceTimeouts.clear();const t=Date.now();e.forEach(s=>{this.pieceTimeouts.set(s.id,{startTime:t,warningShown:!1,timedOut:!1})}),this.timeoutCheckInterval||this.startTimeoutChecking()}resetPieceTimeout(e){if(this.pieceTimeouts.has(e)){this.pieceTimeouts.delete(e);const t=this.blockElements.get(e);t&&t.classList.remove("piece-struggling","piece-timed-out")}}startTimeoutChecking(){this.timeoutCheckInterval&&clearInterval(this.timeoutCheckInterval),this.timeoutCheckInterval=setInterval(()=>{this.checkPieceTimeouts()},500)}stopTimeoutChecking(){this.timeoutCheckInterval&&(clearInterval(this.timeoutCheckInterval),this.timeoutCheckInterval=null),this.blockElements.forEach(e=>{e.classList.remove("piece-struggling","piece-timed-out")}),this.pieceTimeouts.clear()}pauseTimeoutChecking(){this.timeoutPaused=!0;const e=Date.now();this.pieceTimeouts.forEach(t=>{t.pauseTime||(t.pauseTime=e)})}resumeTimeoutChecking(){this.timeoutPaused=!1;const e=Date.now();this.pieceTimeouts.forEach(t=>{if(t.pauseTime){const s=e-t.pauseTime;t.startTime+=s,delete t.pauseTime}})}checkPieceTimeouts(){if(this.timeoutPaused)return;const e=Date.now();this.pieceTimeouts.forEach((t,s)=>{const i=e-t.startTime,o=this.blockElements.get(s);o&&(i>=this.TIMEOUT_TIME&&!t.timedOut?(t.timedOut=!0,o.classList.remove("piece-struggling"),o.classList.add("piece-timed-out"),this.showPieceTimeoutNotification(),this.onPieceTimeout&&this.onPieceTimeout(s)):i>=this.WARNING_TIME&&!t.warningShown&&(t.warningShown=!0,o.classList.add("piece-struggling")))})}showPieceTimeoutNotification(){const e=document.getElementById("blocks-container");if(!e)return;const t=e.getBoundingClientRect(),s=t.left+t.width/2,i=t.top+t.height/2,o=document.createElement("div");o.className="floating-piece-timeout",o.textContent="Piece Lodged in Place!",o.style.position="fixed",o.style.left=`${s}px`,o.style.top=`${i}px`,document.body.appendChild(o),setTimeout(()=>{o.parentElement&&o.parentElement.removeChild(o)},3e3)}setPieceTimeoutCallback(e){this.onPieceTimeout=e}areAllPiecesTimedOut(){if(this.pieceTimeouts.size===0)return!1;let e=!0;return this.pieceTimeouts.forEach(t=>{t.timedOut||(e=!1)}),e}}class W{constructor(e=null){this.score=0,this.level=1,this.linesCleared=0,this.petrificationManager=e,this.combo=0,this.maxCombo=0,this.totalCombos=0,this.maxTotalCombos=0,this.streakCount=0,this.maxStreakCount=0,this.totalStreakBonus=0,this.placementTimes=[],this.speedBonuses=[],this.totalSpeedBonus=0,this.fastestPlacement=null,this.averagePlacementSpeed=0,this.rowsClearedCount=0,this.columnsClearedCount=0,this.squaresClearedCount=0,this.comboActivations=0,this.pointsBreakdown={linePoints:0,squarePoints:0,comboBonusPoints:0,placementPoints:0,streakBonusPoints:0,emptyGridBonusPoints:0},this.lastEmptyGridBonusLevel=0,this.emptyGridBonusThreshold=5,this.basePoints={single:1,line:15,square:20,combo:5},this.speedConfig={mode:"bonus",thresholds:[{maxTime:500,bonus:10,label:"Lightning Fast"},{maxTime:1e3,bonus:5,label:"Very Fast"},{maxTime:2e3,bonus:2,label:"Fast"},{maxTime:3e3,bonus:1,label:"Quick"}],maxBonus:50,streakMultiplier:1.5},this.levelProgression={baseRange:100,stepIncrease:.05,roundingMode:"round"}}setPetrificationManager(e){this.petrificationManager=e}checkForCompletedLines(e){const t={rows:[],columns:[],squares:[]};for(let s=0;s<e.length;s++)this.isRowComplete(e,s)&&(!this.petrificationManager||this.petrificationManager.canClearRow(e,s))&&t.rows.push(s);for(let s=0;s<e[0].length;s++)this.isColumnComplete(e,s)&&(!this.petrificationManager||this.petrificationManager.canClearColumn(e,s))&&t.columns.push(s);for(let s=0;s<3;s++)for(let i=0;i<3;i++)this.isSquareComplete(e,s,i)&&(!this.petrificationManager||this.petrificationManager.canClearSquare(e,s,i))&&t.squares.push({row:s,col:i});return t}checkAndClearLines(e,t=1){const s=this.checkForCompletedLines(e);return this.applyClears(e,s,t)}calculateScoreForClears(e,t=1){const s=e.rows.length,i=e.columns.length,o=e.squares.length,a=s+i+o;if(a===0)return{scoreGained:0,isComboEvent:!1,clearTypes:[],totalClears:0,breakdown:{linePoints:0,squarePoints:0,comboBonus:0}};const l=(s+i)*this.basePoints.line,n=o*this.basePoints.square;let r=l+n;const c=[];s>0&&c.push("row"),i>0&&c.push("column"),o>0&&c.push("square");const h=c.length>=2||a>=2;let d=0;h&&(d=this.calculateComboBonus(a),r+=d);const m=l+n,u=Math.floor(m*t),f=Math.floor(d*t);return r=u+f,{scoreGained:r,isComboEvent:h,clearTypes:c,totalClears:a,breakdown:{linePoints:Math.floor(l*t),squarePoints:Math.floor(n*t),comboBonus:f}}}clearLinesFromBoard(e,t){console.log("ScoringSystem.clearLinesFromBoard called with:",{board:e,clearedLines:t});let s=e.map(o=>[...o]),i=0;return t.rows.forEach(o=>{console.log(`Clearing row ${o}`),s[o]=new Array(e[0].length).fill(0),i++}),t.columns.forEach(o=>{console.log(`Clearing column ${o}`);for(let a=0;a<e.length;a++)s[a][o]=0;i++}),t.squares.forEach(o=>{console.log(`Clearing square at row ${o.row}, col ${o.col}`);const a=o.row*3,l=o.col*3;for(let n=a;n<a+3;n++)for(let r=l;r<l+3;r++)s[n][r]=0;i++}),console.log(`Total cleared: ${i}`),{board:s,clearedCount:i,clearedLines:t}}isRowComplete(e,t){return e[t].every(s=>s===1)}isColumnComplete(e,t){return e.every(s=>s[t]===1)}isSquareComplete(e,t,s){const i=t*3,o=s*3;for(let a=i;a<i+3;a++)for(let l=o;l<o+3;l++)if(e[a][l]!==1)return!1;return!0}applyClears(e,t,s=1){console.log("ScoringSystem.applyClears called with:",{board:e,clearedLines:t});let i=e.map(r=>[...r]),o=0;t.rows.forEach(r=>{console.log(`Clearing row ${r}`),i[r]=new Array(e[0].length).fill(0),o++}),t.columns.forEach(r=>{console.log(`Clearing column ${r}`);for(let c=0;c<e.length;c++)i[c][r]=0;o++}),t.squares.forEach(r=>{console.log(`Clearing square at row ${r.row}, col ${r.col}`);const c=r.row*3,h=r.col*3;for(let d=c;d<c+3;d++)for(let m=h;m<h+3;m++)i[d][m]=0;o++}),console.log(`Total cleared: ${o}`);const a=[];t.rows.length>0&&a.push("row"),t.columns.length>0&&a.push("column"),t.squares.length>0&&a.push("square");const l=t.rows.length+t.columns.length+t.squares.length,n=a.length>=2||l>=2;return o>0?(this.rowsClearedCount+=t.rows.length,this.columnsClearedCount+=t.columns.length,this.squaresClearedCount+=t.squares.length,this.calculateScore(t,n,s),this.linesCleared+=o,n?(this.combo++,this.maxCombo=Math.max(this.maxCombo,this.combo),this.streakCount++,this.maxStreakCount=Math.max(this.maxStreakCount,this.streakCount),this.totalCombos++,this.maxTotalCombos=Math.max(this.maxTotalCombos,this.totalCombos),this.comboActivations++):this.combo=0):(this.combo=0,this.streakCount=0),{board:i,clearedCount:o,scoreGained:this.getLastScoreGained(),isCombo:n,comboTypes:a,clearedLines:t}}calculateScore(e,t=!1,s=1){const i=e.rows.length,o=e.columns.length,a=e.squares.length,l=i+o+a;if(l===0)return;const n=(i+o)*this.basePoints.line,r=a*this.basePoints.square;let c=n+r,h=0,d=0;t&&(h=this.calculateComboBonus(l),c+=h,d=this.calculateStreakBonus(this.streakCount),c+=d);const m=n+r,u=Math.floor(m*s),f=Math.floor(h*s),b=Math.floor(d*s);c=u+f+b,this.pointsBreakdown.linePoints+=Math.floor(n*s),this.pointsBreakdown.squarePoints+=Math.floor(r*s),this.pointsBreakdown.comboBonusPoints+=f,this.pointsBreakdown.streakBonusPoints+=b,this.score+=c,this.lastScoreGained=c,this.updateLevelFromScore()}addPlacementPoints(e,t=1){const s=Math.max(0,e|0);if(s===0)return;const i=Math.floor(s*t);this.score+=i,this.lastScoreGained=i,this.pointsBreakdown.placementPoints+=i,this.updateLevelFromScore()}recordPlacementTime(){const e=Date.now();if(this.placementTimes.push(e),this.speedConfig.mode!=="ignored"&&this.placementTimes.length>=2){const t=e-this.placementTimes[this.placementTimes.length-2],s=this.calculateSpeedBonus(t);s>0&&(this.speedBonuses.push({time:t,bonus:s,timestamp:e}),this.totalSpeedBonus+=s,this.speedConfig.mode==="punishment"?(this.score-=s,this.lastScoreGained-=s):this.speedConfig.mode==="bonus"&&(this.score+=s,this.lastScoreGained+=s),(!this.fastestPlacement||t<this.fastestPlacement)&&(this.fastestPlacement=t),this.updateAveragePlacementSpeed())}}calculateSpeedBonus(e){if(this.speedConfig.mode==="ignored"||e<=0)return 0;for(const t of this.speedConfig.thresholds)if(e<=t.maxTime){let s=t.bonus;if(this.getRecentFastPlacements()>=2&&(s=Math.floor(s*this.speedConfig.streakMultiplier)),this.speedConfig.mode==="punishment"){const a=1+(this.level-1)*.03;s=Math.floor(s*a)}const o=this.speedConfig.maxBonus*(this.speedConfig.mode==="punishment"?2:1);return Math.min(s,o)}return 0}getRecentFastPlacements(){if(this.speedBonuses.length===0)return 0;const e=Math.min(5,this.speedBonuses.length);return this.speedBonuses.slice(-e).filter(s=>s.bonus>0).length}updateAveragePlacementSpeed(){if(this.placementTimes.length<2){this.averagePlacementSpeed=0;return}let e=0;for(let t=1;t<this.placementTimes.length;t++)e+=this.placementTimes[t]-this.placementTimes[t-1];this.averagePlacementSpeed=e/(this.placementTimes.length-1)}getSpeedStats(){return{totalSpeedBonus:this.totalSpeedBonus,fastestPlacement:this.fastestPlacement,averagePlacementSpeed:this.averagePlacementSpeed,speedBonuses:this.speedBonuses,recentFastPlacements:this.getRecentFastPlacements(),totalPlacements:this.placementTimes.length}}setSpeedMode(e){["bonus","punishment","ignored"].includes(e)?this.speedConfig.mode=e:(console.warn(`Invalid speed mode: ${e}. Using 'bonus' as default.`),this.speedConfig.mode="bonus")}getSpeedMode(){return this.speedConfig.mode}setSpeedBonusEnabled(e){this.speedConfig.mode=e?"bonus":"ignored"}isSpeedBonusEnabled(){return this.speedConfig.mode!=="ignored"}setSpeedPunishmentMode(e){this.speedConfig.mode=e?"punishment":"bonus"}isSpeedPunishmentMode(){return this.speedConfig.mode==="punishment"}resetStreak(){this.combo=0,this.streakCount=0}getLastScoreGained(){return this.lastScoreGained||0}getScore(){return this.score}getLevel(){return this.level}getCombo(){return this.combo}getMaxCombo(){return this.maxCombo}getTotalCombos(){return this.totalCombos}getMaxTotalCombos(){return this.maxTotalCombos}getComboTotal(){return this.comboActivations}getLinesCleared(){return this.linesCleared}reset(){this.score=0,this.level=1,this.linesCleared=0,this.combo=0,this.maxCombo=0,this.totalCombos=0,this.maxTotalCombos=0,this.streakCount=0,this.maxStreakCount=0,this.totalStreakBonus=0,this.placementTimes=[],this.speedBonuses=[],this.totalSpeedBonus=0,this.fastestPlacement=null,this.averagePlacementSpeed=0,this.lastScoreGained=0,this.rowsClearedCount=0,this.columnsClearedCount=0,this.squaresClearedCount=0,this.comboActivations=0,this.pointsBreakdown={linePoints:0,squarePoints:0,comboBonusPoints:0,placementPoints:0,streakBonusPoints:0,emptyGridBonusPoints:0},this.lastEmptyGridBonusLevel=0}applyRounding(e,t){switch(t){case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);case"round":return Math.round(e);default:return e}}getLevelThreshold(e){if(e<=1)return 0;const t=this.levelProgression.baseRange,s=this.levelProgression.stepIncrease,i=this.levelProgression.roundingMode;let o=101,a=t;for(let l=2;l<e;l++)a=this.applyRounding(a*(1+s),i),o+=a;return o}updateLevelFromScore(){let e=1;const t=200;for(let s=2;s<=t;s++){const i=this.getLevelThreshold(s);if(this.score>=i){e=s;continue}break}e>this.level&&(this.level=e)}countEmptySquares(e){if(!e||!Array.isArray(e)||e.length===0)return 0;let t=0;for(let s=0;s<e.length;s++)for(let i=0;i<e[s].length;i++)e[s][i]===0&&t++;return t}shouldGiveEmptyGridBonus(){return this.level%this.emptyGridBonusThreshold===0&&this.level>this.lastEmptyGridBonusLevel}calculateEmptyGridBonus(e){return this.shouldGiveEmptyGridBonus()?this.countEmptySquares(e)*2:0}applyEmptyGridBonus(e){if(!this.shouldGiveEmptyGridBonus())return 0;const t=this.calculateEmptyGridBonus(e);return t>0&&(this.score+=t,this.lastScoreGained+=t,this.pointsBreakdown.emptyGridBonusPoints+=t,this.lastEmptyGridBonusLevel=this.level),t}calculateComboBonus(e){if(e<2)return 0;let t=0;for(let s=2;s<=e;s++)s===2?t+=10:s===3||s===4?t+=15:s===5?t+=50:t+=100;return t}calculateStreakBonus(e){return e<2?0:e<=10?e*10:100+(e-10)*100}getStats(){return{score:this.score,level:this.level,linesCleared:this.linesCleared,combo:this.combo,maxCombo:this.maxCombo,totalCombos:this.totalCombos,maxTotalCombos:this.maxTotalCombos,streakCount:this.streakCount,maxStreakCount:this.maxStreakCount,totalStreakBonus:this.totalStreakBonus,rowClears:this.rowsClearedCount,columnClears:this.columnsClearedCount,squareClears:this.squaresClearedCount,comboActivations:this.comboActivations,breakdownBase:{linePoints:this.pointsBreakdown.linePoints,squarePoints:this.pointsBreakdown.squarePoints,comboBonusPoints:this.pointsBreakdown.comboBonusPoints,placementPoints:this.pointsBreakdown.placementPoints,streakBonusPoints:this.pointsBreakdown.streakBonusPoints,emptyGridBonusPoints:this.pointsBreakdown.emptyGridBonusPoints},speedStats:this.getSpeedStats()}}}class A{constructor(){this.isOnline=navigator.onLine,this.offlineIndicator=null,this.init()}init(){this.setupEventListeners(),this.createOfflineIndicator(),this.updateOfflineStatus()}setupEventListeners(){window.addEventListener("online",()=>{console.log("PWA: Back online"),this.isOnline=!0,this.updateOfflineStatus()}),window.addEventListener("offline",()=>{console.log("PWA: Gone offline"),this.isOnline=!1,this.updateOfflineStatus()}),document.addEventListener("visibilitychange",()=>{document.hidden?this.handleAppBlur():this.handleAppFocus()})}createOfflineIndicator(){this.offlineIndicator=document.createElement("div"),this.offlineIndicator.id="offline-indicator",this.offlineIndicator.className="offline-indicator",this.offlineIndicator.innerHTML="ðŸ“¡ Offline Mode",this.offlineIndicator.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff6b35;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        `,document.body.appendChild(this.offlineIndicator)}updateOfflineStatus(){this.offlineIndicator&&(this.isOnline?(this.offlineIndicator.style.transform="translateY(-100%)",this.offlineIndicator.innerHTML="ðŸ“¡ Offline Mode"):(this.offlineIndicator.style.transform="translateY(0)",this.offlineIndicator.innerHTML="ðŸ“¡ Offline Mode - Game works without internet!"))}handleAppBlur(){console.log("PWA: App blurred")}handleAppFocus(){console.log("PWA: App focused")}isStandalone(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0}getStatus(){return{isOnline:this.isOnline,isStandalone:this.isStandalone(),supportsOffline:"serviceWorker"in navigator}}}const _=Object.freeze(Object.defineProperty({__proto__:null,OfflineManager:A},Symbol.toStringTag,{value:"Module"}));class j{constructor(){this.currentDifficulty="normal",this.difficultySettings=this.initializeDifficultySettings(),this.gameRules=this.initializeGameRules()}initializeDifficultySettings(){return{easy:{name:"Easy",description:"Larger blocks, slower pace, hints available",blockSizeRange:[2,4],allowedShapes:["square2x2","square3x3","l2x2","line2","line3"],scoreMultiplier:1.5,timeLimit:null,hintsEnabled:!0,blockGenerationDelay:2e3,visualHints:!0},normal:{name:"Normal",description:"Standard block variety, moderate pace",blockSizeRange:[1,5],allowedShapes:"all",scoreMultiplier:1,timeLimit:null,hintsEnabled:!1,blockGenerationDelay:1500,visualHints:!1},hard:{name:"Hard",description:"Smaller blocks, faster pace, no hints",blockSizeRange:[1,3],allowedShapes:["single","line2","line3","l2x2","t3x2","z3x2"],scoreMultiplier:.8,timeLimit:null,hintsEnabled:!1,blockGenerationDelay:1e3,visualHints:!1},expert:{name:"Expert",description:"Complex shapes, time pressure, limited moves",blockSizeRange:[1,4],allowedShapes:"all",scoreMultiplier:.5,timeLimit:300,hintsEnabled:!1,blockGenerationDelay:800,visualHints:!1,moveLimit:50}}}initializeGameRules(){return{basePoints:{single:10,line:100,combo:50},levelThresholds:{easy:[100,300,600,1e3,1500,2200,3e3,4e3,5200,6600],normal:[200,500,900,1400,2e3,2700,3500,4400,5400,6500],hard:[150,400,700,1100,1600,2200,2900,3700,4600,5600],expert:[100,250,450,700,1e3,1350,1750,2200,2700,3250]},comboThresholds:{easy:2,normal:3,hard:4,expert:5}}}setDifficulty(e){return this.difficultySettings[e]?(this.currentDifficulty=e,!0):!1}getCurrentDifficulty(){return this.currentDifficulty}getDifficultySettings(){return this.difficultySettings[this.currentDifficulty]}getScoreMultiplier(){return this.difficultySettings[this.currentDifficulty].scoreMultiplier}getTimeLimit(){return this.difficultySettings[this.currentDifficulty].timeLimit}isHintsEnabled(){return this.difficultySettings[this.currentDifficulty].hintsEnabled}getBlockGenerationDelay(){return this.difficultySettings[this.currentDifficulty].blockGenerationDelay}hasVisualHints(){return this.difficultySettings[this.currentDifficulty].visualHints}getMoveLimit(){return this.difficultySettings[this.currentDifficulty].moveLimit||null}getAllowedShapes(){return this.difficultySettings[this.currentDifficulty].allowedShapes}getBlockSizeRange(){return this.difficultySettings[this.currentDifficulty].blockSizeRange}getLevelThresholds(){return this.gameRules.levelThresholds[this.currentDifficulty]}getComboThreshold(){return this.gameRules.comboThresholds[this.currentDifficulty]}calculateScore(e,t=1){const s=this.getScoreMultiplier();return Math.floor(e*s)}shouldGenerateNewBlocks(e,t){const s=this.getLevelThresholds();return t<=s.length&&e>=s[t-1]}getDifficultyInfo(){const e=this.getDifficultySettings();return{name:e.name,description:e.description,features:{hints:e.hintsEnabled,timer:e.timeLimit!==null,moveLimit:e.moveLimit!==null}}}getAvailableDifficulties(){return Object.keys(this.difficultySettings).map(e=>({key:e,...this.difficultySettings[e]}))}reset(){this.currentDifficulty="normal"}}class Y{constructor(e,t){this.game=e,this.difficultyManager=t,this.hintsActive=!1,this.validPositions=[],this.hintCooldown=0,this.lastHintTime=0,this.hintDuration=5e3,this.cooldownDuration=1e4}update(e){this.hintCooldown>0&&(this.hintCooldown-=e)}isHintAvailable(){return this.difficultyManager.isHintsEnabled()&&this.game.enableHints&&this.hintCooldown<=0&&this.game.selectedBlock!==null}toggleHints(){this.hintsActive?this.hideHints():this.showHint(),this.game.updateHintControls&&this.game.updateHintControls()}showHint(){return this.isHintAvailable()?(this.hintsActive=!0,this.lastHintTime=Date.now(),this.hintCooldown=this.cooldownDuration,this.findValidPositions(),!0):!1}hideHints(){this.hintsActive=!1,this.validPositions=[],this.game.drawBoard()}findValidPositions(){if(!this.game.selectedBlock)return;this.validPositions=[];const e=this.game.selectedBlock;this.game.board;const t=this.game.boardSize;for(let s=0;s<t;s++)for(let i=0;i<t;i++)this.game.canPlaceBlock(s,i)&&this.validPositions.push({row:s,col:i});this.validPositions.sort((s,i)=>{const o=this.calculatePositionScore(s.row,s.col,e);return this.calculatePositionScore(i.row,i.col,e)-o})}calculatePositionScore(e,t,s){let i=0;const o=this.simulateBlockPlacement(e,t,s),a=this.game.scoringSystem.checkAndClearLines(o);i+=(a.rows.length+a.columns.length+a.squares.length)*100,(a.rows.length>1||a.columns.length>1||a.squares.length>1)&&(i+=200);const l=this.game.boardSize/2,n=this.game.boardSize/2,r=Math.abs(e-l)+Math.abs(t-n);return i+=(this.game.boardSize-r)*10,i}simulateBlockPlacement(e,t,s){const i=this.game.board.map(o=>[...o]);return this.game.blockManager.canPlaceBlock(s,e,t,i)?this.game.blockManager.placeBlock(s,e,t,i):i}drawHints(e){if(!this.hintsActive||this.validPositions.length===0)return;const t=this.game.actualCellSize||this.game.cellSize;e.save(),e.globalAlpha=.8,this.validPositions.slice(0,3).forEach((i,o)=>{const a=i.col*t,l=i.row*t,n="#4CAF50",r=o===0?3:2;e.strokeStyle=n,e.lineWidth=r,e.setLineDash(o===0?[]:[5,5]),e.strokeRect(a+1,l+1,t-2,t-2),e.shadowColor=n,e.shadowBlur=8,e.strokeRect(a+1,l+1,t-2,t-2)}),e.restore()}getHintCount(){return this.validPositions.length}getBestPosition(){return this.validPositions.length>0?this.validPositions[0]:null}getHintStatus(){return{active:this.hintsActive,available:this.isHintAvailable(),cooldownRemaining:Math.max(0,this.hintCooldown),validPositions:this.validPositions.length}}forceShowHints(){this.hintsActive=!0,this.hintCooldown=0,this.findValidPositions()}reset(){this.hintsActive=!1,this.validPositions=[],this.hintCooldown=0,this.lastHintTime=0}}class V{constructor(e){this.difficultyManager=e,this.timeLimit=null,this.timeRemaining=0,this.isActive=!1,this.isPaused=!1,this.startTime=0,this.pausedTime=0,this.timeBonus=0,this.warningThreshold=30,this.criticalThreshold=10}initialize(){this.timeLimit=this.difficultyManager.getTimeLimit(),this.timeLimit&&(this.timeRemaining=this.timeLimit,this.isActive=!0)}start(){!this.isActive||this.timeLimit===null||(this.startTime=Date.now(),this.isPaused=!1,this.pausedTime=0)}pause(){!this.isActive||this.isPaused||(this.isPaused=!0,this.pausedTime=Date.now())}resume(){if(!this.isActive||!this.isPaused)return;const e=Date.now()-this.pausedTime;this.startTime+=e,this.isPaused=!1}update(){if(!this.isActive||this.isPaused||this.timeLimit===null||this.startTime===0)return!0;const e=Date.now()-this.startTime;return this.timeRemaining=Math.max(0,this.timeLimit-Math.floor(e/1e3)),this.timeRemaining>0}addTimeBonus(e){this.timeRemaining+=e,this.timeBonus+=e}getTimeRemaining(){return this.timeRemaining}getTimeBonus(){return this.timeBonus}isTimeUp(){return this.isActive&&this.timeLimit!==null&&this.startTime>0&&this.timeRemaining<=0}isWarningTime(){return this.timeRemaining<=this.warningThreshold&&this.timeRemaining>this.criticalThreshold}isCriticalTime(){return this.timeRemaining<=this.criticalThreshold}getTimeStatus(){return{remaining:this.timeRemaining,limit:this.timeLimit,isActive:this.isActive,isPaused:this.isPaused,isWarning:this.isWarningTime(),isCritical:this.isCriticalTime(),bonus:this.timeBonus}}formatTime(e){const t=Math.floor(e/60),s=e%60;return`${t}:${s.toString().padStart(2,"0")}`}getFormattedTimeRemaining(){return this.formatTime(this.timeRemaining)}getFormattedTimeLimit(){return this.formatTime(this.timeLimit)}calculateTimeBonus(e){const t=e.rows.length+e.columns.length+e.squares.length;if(t===0)return 0;let s=t*5;t>1&&(s+=(t-1)*3);const i=this.difficultyManager.getComboThreshold();return t>=i&&(s+=10),s}getTimePressureEffects(){return this.isActive?this.isCriticalTime()?{type:"critical",color:"#ff0000",intensity:1,pulse:!0}:this.isWarningTime()?{type:"warning",color:"#ff8800",intensity:.7,pulse:!1}:null:null}reset(){this.timeRemaining=this.timeLimit||0,this.isActive=this.timeLimit!==null,this.isPaused=!1,this.startTime=0,this.pausedTime=0,this.timeBonus=0}disable(){this.isActive=!1,this.timeLimit=null,this.timeRemaining=0}}class X{constructor(e,t){this.game=e,this.difficultyManager=t,this.container=null,this.isVisible=!1,this.confirmationDialog=new G}create(){this.container=document.createElement("div"),this.container.id="difficulty-selector",this.container.className="difficulty-selector";const e=document.createElement("div");e.className="difficulty-overlay";const t=()=>this.hide();e.addEventListener("click",t),e.addEventListener("touchstart",r=>{r.preventDefault(),t()},{passive:!1});const s=document.createElement("div");s.className="difficulty-modal";const i=document.createElement("div");i.className="difficulty-header",i.innerHTML="<h2>Select Difficulty</h2>";const o=document.createElement("div");o.className="difficulty-options",this.difficultyManager.getAvailableDifficulties().forEach(r=>{const c=this.createDifficultyOption(r);o.appendChild(c)});const l=document.createElement("button");l.className="difficulty-close",l.innerHTML="Ã—";const n=()=>this.hide();l.addEventListener("click",n),l.addEventListener("touchstart",r=>{r.preventDefault(),n()},{passive:!1}),s.appendChild(i),s.appendChild(o),s.appendChild(l),this.container.appendChild(e),this.container.appendChild(s),document.body.appendChild(this.container),this.addStyles()}createDifficultyOption(e){const t=document.createElement("div");t.className="difficulty-option",t.dataset.difficulty=e.key,e.key===this.difficultyManager.getCurrentDifficulty()&&t.classList.add("selected");const s=document.createElement("div");s.className="difficulty-icon",s.innerHTML=this.getDifficultyIcon(e.key);const i=document.createElement("div");i.className="difficulty-content";const o=document.createElement("h3");o.textContent=e.name;const a=document.createElement("p");a.textContent=e.description;const l=document.createElement("div");if(l.className="difficulty-features",e.hintsEnabled){const u=document.createElement("span");u.className="feature hint",u.textContent="Hints",l.appendChild(u)}if(e.undoEnabled){const u=document.createElement("span");u.className="feature undo",u.textContent="Undo",l.appendChild(u)}if(e.timeLimit){const u=document.createElement("span");u.className="feature timer",u.textContent="Timer",l.appendChild(u)}if(e.moveLimit){const u=document.createElement("span");u.className="feature moves",u.textContent="Limited Moves",l.appendChild(u)}i.appendChild(o),i.appendChild(a),i.appendChild(l),t.appendChild(s),t.appendChild(i);let n=null,r=null,c=!1;const h=async u=>{u.preventDefault(),await this.selectDifficulty(e.key)},d=u=>{u.preventDefault(),!c&&(c=!0,n=Date.now(),t.classList.add("pressing"),r=setTimeout(()=>{c&&(h(u),this.resetPressState(t,r,c))},1500))},m=u=>{c&&(u.preventDefault(),this.resetPressState(t,r,c))};return t.addEventListener("mousedown",d),t.addEventListener("mouseup",m),t.addEventListener("mouseleave",m),t.addEventListener("touchstart",d,{passive:!1}),t.addEventListener("touchend",m,{passive:!1}),t.addEventListener("touchcancel",m,{passive:!1}),t.addEventListener("click",async u=>{u.preventDefault(),!c&&(!n||Date.now()-n<200)&&await h(u)}),t}getDifficultyIcon(e){return{easy:"ðŸ˜Š",normal:"ðŸ˜",hard:"ðŸ˜¤",expert:"ðŸ”¥"}[e]||"ðŸŽ®"}async selectDifficulty(e){(this.game.score>0||this.game.board.some(s=>s.some(i=>i===1)))&&!await this.confirmationDialog.show(`Changing difficulty to ${e.toUpperCase()} will reset your current game and you'll lose your progress. Are you sure you want to continue?`)||(this.difficultyManager.setDifficulty(e),this.updateSelection(e),this.game.restartWithDifficulty(e),this.hide())}updateSelection(e){this.container.querySelectorAll(".difficulty-option").forEach(s=>{s.dataset.difficulty===e?s.classList.add("selected"):s.classList.remove("selected")})}resetPressState(e,t,s){t&&clearTimeout(t),e.classList.remove("pressing")}show(){this.container||this.create(),this.container.style.display="flex",this.container.style.pointerEvents="auto",this.isVisible=!0,requestAnimationFrame(()=>{this.container.classList.add("show")})}hide(){this.container&&(this.container.classList.remove("show"),this.isVisible=!1,this.container.style.pointerEvents="none",setTimeout(()=>{this.container&&this.container.parentNode&&(this.container.parentNode.removeChild(this.container),this.container=null)},300))}addStyles(){const e=document.createElement("style");e.textContent=`
            .difficulty-selector {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
                display: none;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            
            .difficulty-selector.show {
                opacity: 1;
                pointer-events: auto;
            }
            
            .difficulty-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                pointer-events: auto;
            }
            
            .difficulty-modal {
                position: relative;
                background: var(--card-bg, var(--header-bg, white));
                border: 2px solid var(--border-color, #e0e0e0);
                border-radius: 12px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }
            
            .difficulty-selector.show .difficulty-modal {
                transform: scale(1);
            }
            
            .difficulty-header {
                text-align: center;
                margin-bottom: 24px;
            }
            
            .difficulty-header h2 {
                margin: 0;
                color: var(--text-color, #333);
                font-size: 1.5rem;
            }
            
            .difficulty-options {
                display: grid;
                gap: 12px;
            }
            
            .difficulty-option {
                display: flex;
                align-items: center;
                padding: 16px;
                border: 2px solid var(--border-color, #e0e0e0);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                background: var(--card-bg, var(--header-bg, white));
            }
            
            .difficulty-option:hover {
                border-color: var(--primary-color, #007bff);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
            }
            
            .difficulty-option.selected {
                border-color: var(--primary-color, #007bff);
                background: var(--primary-color, #007bff);
                color: white !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7) !important;
            }
            
            .difficulty-option.pressing {
                transform: scale(0.98);
                opacity: 0.8;
                border-color: var(--primary-color, #007bff);
                background: var(--primary-color, #007bff);
                color: white !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7) !important;
            }
            
            .difficulty-option.pressing .difficulty-content h3 {
                color: white !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7) !important;
            }
            
            .difficulty-option.pressing .difficulty-content p {
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }
            
            .difficulty-icon {
                font-size: 2rem;
                margin-right: 16px;
                min-width: 40px;
                text-align: center;
            }
            
            .difficulty-content {
                flex: 1;
            }
            
            .difficulty-content h3 {
                margin: 0 0 8px 0;
                color: var(--text-color, #333);
                font-size: 1.1rem;
            }
            
            .difficulty-option.selected .difficulty-content h3 {
                color: white !important;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7) !important;
            }
            
            .difficulty-content p {
                margin: 0 0 8px 0;
                color: var(--text-muted, #666);
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .difficulty-option.selected .difficulty-content p {
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }
            
            .difficulty-features {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .feature {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .feature.hint {
                background: #e8f5e8;
                color: #2d5a2d;
            }
            
            .feature.undo {
                background: #fff3cd;
                color: #856404;
            }
            
            .feature.timer {
                background: #f8d7da;
                color: #721c24;
            }
            
            .feature.moves {
                background: #d1ecf1;
                color: #0c5460;
            }
            
            .difficulty-close {
                position: absolute;
                top: 12px;
                right: 12px;
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--text-muted, #999);
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.2s ease;
            }
            
            .difficulty-close:hover {
                background: var(--cell-hover, #f0f0f0);
                color: var(--text-color, #333);
            }
            
            @media (max-width: 480px) {
                .difficulty-modal {
                    padding: 16px;
                    margin: 16px;
                }
                
                .difficulty-option {
                    padding: 12px;
                }
                
                .difficulty-icon {
                    font-size: 1.5rem;
                    margin-right: 12px;
                }
            }
        `,document.head.appendChild(e)}}class K{constructor(e,t){this.canvas=e,this.ctx=t,this.particles=[],this.isEnabled=!0,this.maxParticles=200,this.animate()}setEnabled(e){this.isEnabled=e,e||(this.particles=[])}getThemeColor(e){try{const t=getComputedStyle(document.documentElement).getPropertyValue(e).trim();if(!t)throw new Error(`Theme color variable '${e}' not found`);return t}catch(t){throw console.error(`Failed to get theme color '${e}':`,t),new Error(`Theme color '${e}' is required but not available`)}}createSparkles(e,t,s=8){if(this.isEnabled)for(let i=0;i<s;i++)this.particles.push(new Q(e,t))}createConfetti(e,t,s=20){if(this.isEnabled)for(let i=0;i<s;i++)this.particles.push(new Z(e,t))}createGlowTrail(e,t,s=null){if(!this.isEnabled)return;const i=s||this.getThemeColor("--clear-glow-color");this.particles.push(new J(e,t,i))}createScoreNumber(e,t,s,i=null){if(!this.isEnabled)return;const o=i||this.getThemeColor("--clear-glow-color");this.particles.push(new ee(e,t,s,o))}createLevelUpEffect(e,t){this.isEnabled&&(this.createConfetti(e,t,30),this.createSparkles(e,t,15),this.particles.push(new te(e,t)))}createEmptyGridBonusEffect(e,t){if(this.isEnabled){for(let s=0;s<20;s++)this.particles.push(new ie(e,t));for(let s=0;s<15;s++)this.particles.push(new oe(e,t));this.particles.push(new ae(e,t))}}createComboEffect(e,t,s){this.isEnabled&&(this.createSparkles(e,t,s*3),this.particles.push(new se(e,t,s)))}update(){if(this.isEnabled){for(let e=this.particles.length-1;e>=0;e--){const t=this.particles[e];t.update(),t.isDead()&&this.particles.splice(e,1)}this.particles.length>this.maxParticles&&(this.particles=this.particles.slice(-this.maxParticles))}}render(){if(this.isEnabled){this.ctx.save();for(const e of this.particles)e.render(this.ctx);this.ctx.restore()}}animate(){this.update(),this.render(),requestAnimationFrame(()=>this.animate())}clear(){this.particles=[]}}class y{constructor(e,t){this.x=e,this.y=t,this.vx=0,this.vy=0,this.life=1,this.maxLife=1,this.size=1,this.color="#ffffff",this.alpha=1}update(){this.x+=this.vx,this.y+=this.vy,this.life-=.016,this.alpha=this.life}isDead(){return this.life<=0}render(e){}}class Q extends y{constructor(e,t){super(e,t),this.vx=(Math.random()-.5)*4,this.vy=(Math.random()-.5)*4,this.maxLife=.8,this.life=this.maxLife,this.size=Math.random()*3+1,this.color=`hsl(${Math.random()*60+40}, 100%, 70%)`,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.2}update(){super.update(),this.rotation+=this.rotationSpeed,this.vy+=.1}render(e){e.save(),e.globalAlpha=this.alpha,e.translate(this.x,this.y),e.rotate(this.rotation),e.fillStyle=this.color,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.restore()}}class Z extends y{constructor(e,t){super(e,t),this.vx=(Math.random()-.5)*8,this.vy=Math.random()*-6-2,this.maxLife=2,this.life=this.maxLife,this.size=Math.random()*4+2,this.colors=["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3"],this.color=this.colors[Math.floor(Math.random()*this.colors.length)],this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.3}update(){super.update(),this.rotation+=this.rotationSpeed,this.vy+=.3,this.vx*=.98}render(e){e.save(),e.globalAlpha=this.alpha,e.translate(this.x,this.y),e.rotate(this.rotation),e.fillStyle=this.color,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.restore()}}class J extends y{constructor(e,t,s){super(e,t),this.vx=(Math.random()-.5)*2,this.vy=(Math.random()-.5)*2,this.maxLife=.5,this.life=this.maxLife,this.size=Math.random()*6+3,this.color=s}update(){super.update(),this.size*=.98}render(e){e.save(),e.globalAlpha=this.alpha*.6,e.fillStyle=this.color,e.shadowColor=this.color,e.shadowBlur=10,e.beginPath(),e.arc(this.x,this.y,this.size,0,Math.PI*2),e.fill(),e.restore()}}class ee extends y{constructor(e,t,s,i){super(e,t),this.vx=0,this.vy=-2,this.maxLife=1.5,this.life=this.maxLife,this.score=s,this.color=i,this.fontSize=20}update(){super.update(),this.fontSize+=.5}render(e){e.save(),e.globalAlpha=this.alpha,e.fillStyle=this.color,e.font=`bold ${this.fontSize}px Arial`,e.textAlign="center",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=2,e.fillText(`+${this.score}`,this.x,this.y),e.restore()}}class te extends y{constructor(e,t){super(e,t),this.vx=0,this.vy=-1,this.maxLife=2,this.life=this.maxLife,this.text="LEVEL UP!",this.color="#ffd700",this.fontSize=24}update(){super.update(),this.fontSize+=.3}render(e){e.save(),e.globalAlpha=this.alpha,e.fillStyle=this.color,e.font=`bold ${this.fontSize}px Arial`,e.textAlign="center",e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=4,e.fillText(this.text,this.x,this.y),e.restore()}}class se extends y{constructor(e,t,s){super(e,t),this.vx=0,this.vy=-1.5,this.maxLife=1.5,this.life=this.maxLife,this.text=`${s}x COMBO!`,this.color="#ff6b6b",this.fontSize=18}update(){super.update(),this.fontSize+=.2}render(e){e.save(),e.globalAlpha=this.alpha,e.fillStyle=this.color,e.font=`bold ${this.fontSize}px Arial`,e.textAlign="center",e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=3,e.fillText(this.text,this.x,this.y),e.restore()}}class ie extends y{constructor(e,t){super(e,t),this.vx=(Math.random()-.5)*6,this.vy=(Math.random()-.5)*6,this.maxLife=1.2,this.life=this.maxLife,this.size=Math.random()*4+2,this.color=`hsl(${Math.random()*40+120}, 100%, 60%)`,this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.3}update(){super.update(),this.rotation+=this.rotationSpeed,this.vy+=.05,this.size*=.99}render(e){e.save(),e.globalAlpha=this.alpha,e.translate(this.x,this.y),e.rotate(this.rotation),e.fillStyle=this.color,e.shadowColor=this.color,e.shadowBlur=8,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.restore()}}class oe extends y{constructor(e,t){super(e,t),this.vx=(Math.random()-.5)*10,this.vy=Math.random()*-8-3,this.maxLife=2.5,this.life=this.maxLife,this.size=Math.random()*5+3,this.colors=["#00ff88","#00cc66","#00ffaa","#66ff99","#00ff77","#33ff88"],this.color=this.colors[Math.floor(Math.random()*this.colors.length)],this.rotation=Math.random()*Math.PI*2,this.rotationSpeed=(Math.random()-.5)*.4}update(){super.update(),this.rotation+=this.rotationSpeed,this.vy+=.2,this.vx*=.98}render(e){e.save(),e.globalAlpha=this.alpha,e.translate(this.x,this.y),e.rotate(this.rotation),e.fillStyle=this.color,e.shadowColor=this.color,e.shadowBlur=6,e.fillRect(-this.size/2,-this.size/2,this.size,this.size),e.restore()}}class ae extends y{constructor(e,t){super(e,t),this.vx=0,this.vy=-1.5,this.maxLife=2,this.life=this.maxLife,this.text="EMPTY GRID BONUS!",this.color="#00ff88",this.fontSize=22}update(){super.update(),this.fontSize+=.4}render(e){e.save(),e.globalAlpha=this.alpha,e.fillStyle=this.color,e.font=`bold ${this.fontSize}px Arial`,e.textAlign="center",e.shadowColor="rgba(0, 255, 136, 0.8)",e.shadowBlur=6,e.fillText(this.text,this.x,this.y),e.restore()}}class ne{constructor(){this.isEnabled=!0,this.isSupported=this.checkSupport(),this.userHasInteracted=!1,this.lastVibrationTime=0,this.vibrationThrottle=100,this.vibrationPatterns={light:[10],medium:[20],heavy:[50],success:[20,10,20],error:[100],blockPlace:[15],lineClear:[30,10,30],levelUp:[50,20,50],combo:[25,10,25,10,25],speedBonus:[20,5,20],buttonClick:[5],emptyGridBonus:[40,15,40,15,40]},this.setupUserInteractionListener()}checkSupport(){return"vibrate"in navigator}setupUserInteractionListener(){const e=()=>{this.userHasInteracted=!0,document.removeEventListener("click",e),document.removeEventListener("touchstart",e),document.removeEventListener("keydown",e)};document.addEventListener("click",e,{once:!0}),document.addEventListener("touchstart",e,{once:!0}),document.addEventListener("keydown",e,{once:!0})}setEnabled(e){this.isEnabled=e}enableAfterInteraction(){this.userHasInteracted=!0}vibrate(e){if(!this.isEnabled||!this.isSupported||!this.userHasInteracted)return;const t=Date.now();if(!(t-this.lastVibrationTime<this.vibrationThrottle))try{typeof e=="string"&&(e=this.vibrationPatterns[e]||[10]),navigator.vibrate(e),this.lastVibrationTime=t}catch(s){console.warn("Haptic feedback error:",s)}}onBlockPlace(){this.vibrate("blockPlace")}onLineClear(){this.vibrate("lineClear")}onLevelUp(){this.vibrate("levelUp")}onCombo(e){e>=1&&this.vibrate("combo")}onSpeedBonus(){this.vibrate("speedBonus")}onEmptyGridBonus(){this.vibrate("emptyGridBonus")}onError(){this.vibrate("error")}onButtonClick(){this.vibrate("buttonClick")}onSuccess(){this.vibrate("success")}onCustom(e){this.vibrate(e)}stop(){this.isSupported&&navigator.vibrate(0)}getStatus(){return{isEnabled:this.isEnabled,isSupported:this.isSupported,userHasInteracted:this.userHasInteracted,lastVibrationTime:this.lastVibrationTime,vibrationThrottle:this.vibrationThrottle}}}class le{constructor(e,t){this.canvas=e,this.ctx=t,this.particles=new K(e,t),this.sound=new $,this.haptic=new ne,this.settings={particles:!0,sound:!1,haptic:!0}}updateSettings(e){this.settings={...this.settings,...e},this.particles.setEnabled(this.settings.particles),this.sound.setEnabled(this.settings.sound),this.haptic.setEnabled(this.settings.haptic)}setVolume(e){this.sound.setVolume(e)}getThemeColor(e){try{const t=getComputedStyle(document.documentElement).getPropertyValue(e).trim();if(!t)throw new Error(`Theme color variable '${e}' not found`);return t}catch(t){throw console.error(`Failed to get theme color '${e}':`,t),new Error(`Theme color '${e}' is required but not available`)}}onBlockPlace(e,t){this.particles.createSparkles(e,t,6),this.settings.sound&&this.sound.play("blockPlace"),this.haptic.onBlockPlace()}onLineClear(e,t,s){const i=s.rows.length+s.columns.length+s.squares.length;this.particles.createConfetti(e,t,i*5),this.settings.sound&&this.sound.play("lineClear"),this.haptic.onLineClear()}onLevelUp(e,t){this.particles.createLevelUpEffect(e,t),this.settings.sound&&this.sound.play("levelUp"),this.haptic.onLevelUp()}onCombo(e,t,s){this.particles.createComboEffect(e,t,s),this.settings.sound&&this.sound.play("combo"),this.haptic.onCombo(s)}onScoreGain(e,t,s){const i=this.getThemeColor("--clear-glow-color");this.particles.createScoreNumber(e,t,s,i),this.settings.sound&&this.sound.play("scoreGain")}onSpeedBonus(e,t,s){this.particles.createSpeedBonusEffect(e,t,s),this.settings.sound&&this.sound.play("speedBonus"),this.haptic.onSpeedBonus()}onError(){this.settings.sound&&this.sound.play("error"),this.haptic.onError()}onButtonClick(){this.settings.sound&&this.sound.play("buttonClick"),this.haptic.enableAfterInteraction(),this.haptic.onButtonClick()}onBlockRotate(){this.settings.sound&&this.sound.play("blockRotate")}onBlockMove(e,t,s=null){const i=s||this.getThemeColor("--clear-glow-color");this.particles.createGlowTrail(e,t,i)}update(){this.particles.update()}render(){this.particles.render()}clear(){this.particles.clear()}resume(){this.sound.resume()}stop(){this.particles.clear(),this.sound.stop(),this.haptic.stop()}}class re{constructor(){this.enabled=!1,this.gridCellTimestamps={},this.blockTimestamps={},this.GRID_CELL_PETRIFY_TIME=1e4,this.BLOCK_PETRIFY_TIME=3e4,this.WARNING_7S_TIME=7e3,this.WARNING_3S_TIME=3e3,this.stats={gridCellsPetrified:0,blocksPetrified:0,gridCellsThawed:0,blocksThawed:0,totalPetrificationTime:0}}setEnabled(e){const t=this.enabled;this.enabled=e,t&&!e&&this.resetAll()}isEnabled(){return this.enabled}resetAll(){this.gridCellTimestamps={},this.blockTimestamps={}}trackGridCell(e,t){if(!this.enabled)return;const s=`${e},${t}`;this.gridCellTimestamps[s]={timestamp:Date.now(),warned7s:!1,warned3s:!1,petrified:!1}}untrackGridCell(e,t){const s=`${e},${t}`;delete this.gridCellTimestamps[s]}trackBlock(e){this.enabled&&(this.blockTimestamps[e]={timestamp:Date.now(),warned7s:!1,warned3s:!1,petrified:!1})}untrackBlock(e){delete this.blockTimestamps[e]}updateBoardTracking(e){if(this.enabled)for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++){const i=`${t},${s}`;e[t][s]===1?this.gridCellTimestamps[i]||this.trackGridCell(t,s):this.gridCellTimestamps[i]&&this.untrackGridCell(t,s)}}updateBlockTracking(e){if(!this.enabled)return;const t=new Set(e.map(s=>s.id));e.forEach(s=>{this.blockTimestamps[s.id]||this.trackBlock(s.id)}),Object.keys(this.blockTimestamps).forEach(s=>{t.has(s)||this.untrackBlock(s)})}getGridCellState(e,t){if(!this.enabled)return{petrified:!1,warning:null,timeRemaining:1/0};const s=`${e},${t}`,i=this.gridCellTimestamps[s];if(!i)return{petrified:!1,warning:null,timeRemaining:1/0};const o=Date.now()-i.timestamp,a=this.GRID_CELL_PETRIFY_TIME-o;return o>=this.GRID_CELL_PETRIFY_TIME?(i.petrified||(i.petrified=!0,this.stats.gridCellsPetrified++),{petrified:!0,warning:null,timeRemaining:0}):a<=this.WARNING_3S_TIME?{petrified:!1,warning:"3s",timeRemaining:a}:a<=this.WARNING_7S_TIME?{petrified:!1,warning:"7s",timeRemaining:a}:{petrified:!1,warning:null,timeRemaining:a}}getBlockState(e){if(!this.enabled)return{petrified:!1,warning:null,timeRemaining:1/0};const t=this.blockTimestamps[e];if(!t)return{petrified:!1,warning:null,timeRemaining:1/0};const s=Date.now()-t.timestamp,i=this.BLOCK_PETRIFY_TIME-s;return s>=this.BLOCK_PETRIFY_TIME?(t.petrified||(t.petrified=!0,this.stats.blocksPetrified++),{petrified:!0,warning:null,timeRemaining:0}):i<=this.WARNING_3S_TIME?{petrified:!1,warning:"3s",timeRemaining:i}:i<=this.WARNING_7S_TIME?{petrified:!1,warning:"7s",timeRemaining:i}:{petrified:!1,warning:null,timeRemaining:i}}isGridCellPetrified(e,t){return this.getGridCellState(e,t).petrified}isBlockPetrified(e){return this.getBlockState(e).petrified}canClearRow(e,t){if(!this.enabled)return!0;for(let s=0;s<e[t].length;s++)if(e[t][s]===1&&this.isGridCellPetrified(t,s))return!1;return!0}canClearColumn(e,t){if(!this.enabled)return!0;for(let s=0;s<e.length;s++)if(e[s][t]===1&&this.isGridCellPetrified(s,t))return!1;return!0}canClearSquare(e,t,s){if(!this.enabled)return!0;const i=t*3,o=s*3;for(let a=i;a<i+3;a++)for(let l=o;l<o+3;l++)if(e[a][l]===1&&this.isGridCellPetrified(a,l))return!1;return!0}thawAll(){this.enabled&&(Object.keys(this.gridCellTimestamps).forEach(e=>{const t=this.gridCellTimestamps[e];t.petrified&&this.stats.gridCellsThawed++,t.petrified=!1,t.timestamp=Date.now(),t.warned7s=!1,t.warned3s=!1}),Object.keys(this.blockTimestamps).forEach(e=>{const t=this.blockTimestamps[e];t.petrified&&this.stats.blocksThawed++,t.petrified=!1,t.timestamp=Date.now(),t.warned7s=!1,t.warned3s=!1}))}getPetrifiedGridCells(){const e=[];return Object.keys(this.gridCellTimestamps).forEach(t=>{const[s,i]=t.split(",").map(Number);this.isGridCellPetrified(s,i)&&e.push({row:s,col:i})}),e}getPetrifiedBlocks(){return Object.keys(this.blockTimestamps).filter(e=>this.isBlockPetrified(e))}getStats(){return{...this.stats,currentPetrifiedCells:this.getPetrifiedGridCells().length,currentPetrifiedBlocks:this.getPetrifiedBlocks().length}}resetStats(){this.stats={gridCellsPetrified:0,blocksPetrified:0,gridCellsThawed:0,blocksThawed:0,totalPetrificationTime:0}}serialize(){return{enabled:this.enabled,gridCellTimestamps:this.gridCellTimestamps,blockTimestamps:this.blockTimestamps,stats:this.stats}}deserialize(e){e&&(this.enabled=e.enabled||!1,this.gridCellTimestamps=e.gridCellTimestamps||{},this.blockTimestamps=e.blockTimestamps||{},this.stats=e.stats||{gridCellsPetrified:0,blocksPetrified:0,gridCellsThawed:0,blocksThawed:0,totalPetrificationTime:0})}}class ce{constructor(){this.enabled=!1,this.intensity=0,this.deadPixels=new Set,this.stats={deadPixelsGenerated:0,gamesPlayedWithDeadPixels:0}}setEnabled(e){const t=this.enabled;this.enabled=e,t&&!e&&this.clearDeadPixels()}isEnabled(){return this.enabled}setIntensity(e){this.intensity=Math.max(0,Math.min(5,e))}getIntensity(){return this.intensity}generateDeadPixels(e){if(!this.enabled||this.intensity===0){this.deadPixels.clear();return}this.deadPixels.clear();const t=this.intensity*3,s=Math.floor(Math.random()*(this.intensity+1)),i=t+s,o=e*e,a=[];for(let n=0;n<e;n++)for(let r=0;r<e;r++)a.push({row:n,col:r});for(let n=a.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[a[n],a[r]]=[a[r],a[n]]}const l=Math.min(i,o);for(let n=0;n<l;n++){const{row:r,col:c}=a[n],h=`${r},${c}`;this.deadPixels.add(h)}this.stats.deadPixelsGenerated+=l,l>0&&this.stats.gamesPlayedWithDeadPixels++}clearDeadPixels(){this.deadPixels.clear()}isDeadPixel(e,t){if(!this.enabled)return!1;const s=`${e},${t}`;return this.deadPixels.has(s)}getDeadPixels(){const e=[];return this.deadPixels.forEach(t=>{const[s,i]=t.split(",").map(Number);e.push({row:s,col:i})}),e}canPlaceBlockWithDeadPixels(e,t,s,i){if(!this.enabled)return!0;for(let o=0;o<e.shape.length;o++)for(let a=0;a<e.shape[o].length;a++)if(e.shape[o][a]===1){const l=t+o,n=s+a;if(this.isDeadPixel(l,n))return!1}return!0}getStats(){return{...this.stats,currentDeadPixels:this.deadPixels.size}}resetStats(){this.stats={deadPixelsGenerated:0,gamesPlayedWithDeadPixels:0}}serialize(){return{enabled:this.enabled,intensity:this.intensity,deadPixels:Array.from(this.deadPixels),stats:this.stats}}deserialize(e){e&&(this.enabled=e.enabled||!1,this.intensity=e.intensity||0,this.deadPixels=new Set(e.deadPixels||[]),this.stats=e.stats||{deadPixelsGenerated:0,gamesPlayedWithDeadPixels:0})}}class he{constructor(){var e;console.log("BlockdokuGame constructor called"),this.canvas=document.getElementById("game-board"),this.ctx=this.canvas.getContext("2d"),this.boardSize=9,this.cellSize=0,console.log("About to initialize board...");try{this.board=this.initializeBoard(),console.log("Board initialized in constructor:",this.board?"SUCCESS":"FAILED","Length:",(e=this.board)==null?void 0:e.length),console.log("Board contents:",this.board)}catch(t){console.error("ERROR during board initialization:",t),this.board=null}this.score=0,this.level=1,this.currentTheme="light",this.previousScore=0,this.previousLevel=1,this.previousCombo=0,this.previousTotalCombos=0,this.pendingClears=null,this.difficulty="normal",this.enableHints=!1,this.enableTimer=!1,this.moveLimit=null,this.timeLimit=null,this.blockManager=new N,this.petrificationManager=new re,this.deadPixelsManager=new ce,this.blockPalette=new U("block-palette",this.blockManager,this.petrificationManager),this.scoringSystem=new W(this.petrificationManager),this.storage=new O,this.pwaInstallManager=new H,this.offlineManager=new A,this.difficultyManager=new j,this.hintSystem=new Y(this,this.difficultyManager),this.timerSystem=new V(this.difficultyManager),this.difficultySelector=new X(this,this.difficultyManager),this.effectsManager=new le(this.canvas,this.ctx),this.confirmationDialog=new G,this.preGameOverPending=!1,this.selectedBlock=null,this.previewPosition=null,this.isGameOver=!1,this.isInitialized=!1,this.comboModeActive="cumulative",this.comboModesUsed=new Set,this.isDragging=!1,this.dragStartPosition=null,this.dragCurrentPosition=null,this.dragBlockElement=null;try{console.log("About to load settings..."),this.loadSettings(),console.log("Settings loaded, setting isInitialized..."),this.isInitialized=!0,console.log("About to call init()..."),this.init(),console.log("Init completed, setting up resize handler..."),this.setupResizeHandler(),console.log("Constructor completed successfully")}catch(t){console.error("ERROR in constructor after board init:",t)}window.addEventListener("focus",()=>{this.loadSettings(),this.updateDifficultyButton(),this.renderPersonalBests(),this.isGameOver||(console.log("Focus event: reloading game state from settings"),this.loadGameState(),this.render())}),window.addEventListener("storage",t=>{(t.key==="blockdoku-settings"||t.key==="blockdoku_settings")&&(this.loadSettings(),this.updateDifficultyButton(),this.renderPersonalBests(),this.isGameOver||(console.log("Storage change: reloading game state after settings change"),this.loadGameState(),this.render()))})}resizeCanvas(){const e=this.canvas.parentElement;if(!e)return;const t=e.getBoundingClientRect(),s=Math.min(t.width,t.height);this.cellSize=Math.floor(s/this.boardSize),this.cellSize*this.boardSize,this.canvas.width=s,this.canvas.height=s,this.canvas.style.width=s+"px",this.canvas.style.height=s+"px",this.actualCellSize=s/this.boardSize,this.gridCellSize=this.cellSize,this.mouseCellSize=this.actualCellSize,this.ctx.imageSmoothingEnabled=!1,this.ctx.lineCap="square",this.ctx.lineJoin="miter"}initializeBoard(){console.log("initializeBoard called, boardSize:",this.boardSize);const e=[];for(let t=0;t<this.boardSize;t++){e[t]=[];for(let s=0;s<this.boardSize;s++)e[t][s]=0}return console.log("initializeBoard created board with length:",e.length),e}setupResizeHandler(){window.addEventListener("resize",()=>{this.resizeCanvas(),requestAnimationFrame(()=>{this.drawBoard()})})}init(){var e;console.log("Game init() called"),console.log("Board state at start of init():",this.board?"VALID":"UNDEFINED","Length:",(e=this.board)==null?void 0:e.length),this.setupEventListeners(),this.registerServiceWorker(),this.loadGameState(),this.generateNewBlocks(),this.timerSystem.initialize(),setTimeout(()=>{this.resizeCanvas(),requestAnimationFrame(()=>{this.drawBoard(),this.updateUI(),this.renderPersonalBests()})},100),this.isInitialized=!0,this.startGameLoop(),console.log("About to initialize PWA managers..."),this.initializePWAManagers().then(()=>{console.log("PWA managers initialization completed")}).catch(t=>{console.error("PWA managers initialization failed:",t)}),this.updateDifficultyButton(),this.renderPersonalBests(),this.updateUtilityBarState(),this.blockPalette.setPieceTimeoutCallback(t=>{this.handlePieceTimeout(t)})}async registerServiceWorker(){if("serviceWorker"in navigator)try{if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){console.log("PWA: Skipping Service Worker registration in development mode");return}const t=await navigator.serviceWorker.register("./sw.js");console.log("PWA: Service Worker registered successfully",t),t.addEventListener("updatefound",()=>{console.log("PWA: Service Worker update found")})}catch(e){console.log("PWA: Service Worker registration failed (this is normal in development mode)",e.message)}}async initializePWAManagers(){try{console.log("Initializing PWA managers...");const e=await z(()=>import("./sound-manager-3Z7j5x4c.js").then(s=>s.i),__vite__mapDeps([0,1]),import.meta.url),t=await z(()=>Promise.resolve().then(()=>_),void 0,import.meta.url);this.pwaInstallManager=new e.PWAInstallManager,this.offlineManager=new t.OfflineManager,console.log("PWA managers initialized successfully"),console.log("PWAInstallManager:",this.pwaInstallManager),console.log("OfflineManager:",this.offlineManager)}catch(e){console.error("Error initializing PWA managers:",e),this.pwaInstallManager=null,this.offlineManager=null}}startGameLoop(){const e=()=>{this.update(),this.draw(),requestAnimationFrame(e)};e()}update(){this.isGameOver||(this.effectsManager.update(),this.hintSystem&&this.hintSystem.update(16),this.timerSystem&&(!this.timerSystem.update(16)&&this.timerSystem.isTimeUp()&&this.isInitialized&&this.handleTimeUp(),this.updateTimerDisplay()),this.isInitialized&&this.blockManager&&this.blockManager.currentBlocks&&this.blockManager.currentBlocks.length>0&&this.updatePlaceabilityIndicators())}draw(){this.drawBoard(),this.effectsManager.render()}setupEventListeners(){console.log("Setting up event listeners..."),this.canvas.addEventListener("click",n=>this.handleCanvasClick(n)),this.canvas.addEventListener("mousemove",n=>this.handleCanvasMouseMove(n)),this.canvas.addEventListener("mouseleave",()=>this.handleCanvasMouseLeave()),this.canvas.addEventListener("touchstart",n=>this.handleTouchStart(n),{passive:!1}),this.canvas.addEventListener("touchmove",n=>this.handleTouchMove(n),{passive:!1}),this.canvas.addEventListener("touchend",n=>this.handleTouchEnd(n),{passive:!1}),this.canvas.addEventListener("touchcancel",n=>this.handleTouchCancel(n),{passive:!1}),document.addEventListener("touchmove",n=>this.handleGlobalTouchMove(n),{passive:!1}),document.addEventListener("touchend",n=>this.handleGlobalTouchEnd(n),{passive:!1}),document.addEventListener("touchcancel",n=>this.handleGlobalTouchCancel(n),{passive:!1});const e=document.getElementById("settings-toggle");if(e){const n=()=>{this.effectsManager.onButtonClick(),console.log("Settings button clicked - navigating to settings page"),this.isGameOver||(console.log("Saving game state before navigating to settings"),this.saveGameState()),window.location.href="settings.html"};e.addEventListener("click",n),e.addEventListener("touchstart",r=>{r.preventDefault(),n()},{passive:!1})}else console.error("Settings toggle button not found!");const t=document.getElementById("new-game");if(t){const n=()=>{this.effectsManager.onButtonClick(),this.newGame()};t.addEventListener("click",n),t.addEventListener("touchstart",r=>{r.preventDefault(),n()},{passive:!1})}else console.error("New game button not found!");const s=document.getElementById("difficulty-btn");if(s){const n=()=>{this.effectsManager.onButtonClick(),this.difficultySelector.show();const r=document.querySelectorAll("#difficulty-selector");r.length>1&&r.forEach((c,h)=>{h>0&&c.parentNode&&c.parentNode.removeChild(c)})};s.addEventListener("click",n),s.addEventListener("touchstart",r=>{r.preventDefault(),n()},{passive:!1})}else console.error("Difficulty button not found!");const i=document.getElementById("hint-btn");if(i){const n=()=>{this.effectsManager.onButtonClick(),this.hintSystem.toggleHints()};i.addEventListener("click",n),i.addEventListener("touchstart",r=>{r.preventDefault(),n()},{passive:!1})}else console.error("Hint button not found!");const o=document.getElementById("close-high-scores");o&&o.addEventListener("click",()=>this.hideHighScores());const a=document.getElementById("close-difficulty");a&&a.addEventListener("click",()=>this.hideDifficultyModal());const l=document.getElementById("close-settings");l&&l.addEventListener("click",()=>this.hideSettingsModal()),document.querySelectorAll(".difficulty-option").forEach(n=>{n.addEventListener("click",async r=>{await this.selectDifficulty(r.currentTarget.dataset.difficulty)})}),document.getElementById("enable-hints").addEventListener("change",n=>this.toggleSetting("hints",n.target.checked)),document.getElementById("enable-timer").addEventListener("change",n=>this.toggleSetting("timer",n.target.checked)),document.querySelectorAll(".theme-option").forEach(n=>{n.addEventListener("click",r=>this.selectTheme(r.currentTarget.dataset.theme))}),document.addEventListener("blockSelected",n=>this.handleBlockSelected(n)),document.addEventListener("blockDragStart",n=>this.handleBlockDragStart(n)),window.addEventListener("message",async n=>{n.data.type==="difficultyChanged"&&await this.selectDifficulty(n.data.difficulty)}),window.addEventListener("storage",n=>{(n.key==="blockdoku-settings"||n.key==="blockdoku_settings")&&(this.loadSettings(),this.updateHintControls())}),window.addEventListener("beforeunload",()=>{console.log("beforeunload event triggered, autoSave:",this.autoSave,"isGameOver:",this.isGameOver),this.autoSave&&!this.isGameOver&&this.saveGameState()}),document.addEventListener("visibilitychange",()=>{console.log("visibilitychange event triggered, hidden:",document.hidden,"autoSave:",this.autoSave,"isGameOver:",this.isGameOver),document.hidden&&this.autoSave&&!this.isGameOver&&this.saveGameState()})}getBlockCenterOffset(e){const t=e.length,s=e[0].length;let i=0,o=0,a=0;for(let l=0;l<t;l++)for(let n=0;n<s;n++)e[l][n]===1&&(i+=l,o+=n,a++);return a===0?{row:0,col:0}:(i=Math.round(i/a),o=Math.round(o/a),{row:i,col:o})}getBlockDragOffset(e){return{row:0,col:0}}getBlockPlacementOffset(e){return this.getBlockCenterOffset(e)}handleCanvasClick(e){if(this.isGameOver||!this.selectedBlock)return;const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,o=Math.floor(s/this.mouseCellSize),a=Math.floor(i/this.mouseCellSize),l=this.getBlockCenterOffset(this.selectedBlock.shape),n=a-l.row,r=o-l.col;this.canPlaceBlock(n,r)&&this.placeBlock(n,r)}handleCanvasMouseMove(e){if(!this.selectedBlock)return;const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top,o=Math.floor(s/this.mouseCellSize),a=Math.floor(i/this.mouseCellSize),l=this.getBlockCenterOffset(this.selectedBlock.shape),n=a-l.row,r=o-l.col;this.previewPosition={row:n,col:r},this.drawBoard()}handleCanvasMouseLeave(){this.previewPosition=null,this.drawBoard()}handleTouchStart(e){if(e.preventDefault(),this.isGameOver||!this.selectedBlock)return;const t=e.touches[0],s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,o=t.clientY-s.top;this.isDragging=!0,this.dragStartPosition={x:i,y:o},this.dragCurrentPosition={x:i,y:o},this.createDragElement();const a=Math.floor(i/this.mouseCellSize),l=Math.floor(o/this.mouseCellSize),n=this.getBlockPlacementOffset(this.selectedBlock.shape),r=l-n.row,c=a-n.col;this.previewPosition={row:r,col:c},this.drawBoard()}handleTouchMove(e){if(this.isGameOver||!this.isDragging||!this.selectedBlock)return;e.preventDefault();const t=e.touches[0],s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,o=t.clientY-s.top;this.dragCurrentPosition={x:t.clientX,y:t.clientY},this.updateDragElement(t.clientX,t.clientY);const a=Math.floor(i/this.mouseCellSize),l=Math.floor(o/this.mouseCellSize),n=this.getBlockPlacementOffset(this.selectedBlock.shape),r=l-n.row,c=a-n.col;this.previewPosition={row:r,col:c},this.drawBoard()}handleTouchEnd(e){if(e.preventDefault(),this.isGameOver||!this.isDragging||!this.selectedBlock)return;const t=e.changedTouches[0],s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,o=t.clientY-s.top,a=Math.floor(i/this.mouseCellSize),l=Math.floor(o/this.mouseCellSize),n=this.getBlockPlacementOffset(this.selectedBlock.shape),r=l-n.row,c=a-n.col;this.canPlaceBlock(r,c)?this.placeBlock(r,c):this.effectsManager.onError(),this.cleanupDrag()}handleTouchCancel(e){e.cancelable&&e.preventDefault(),this.cleanupDrag()}handleGlobalTouchMove(e){if(this.isGameOver||!this.isDragging||!this.selectedBlock)return;e.preventDefault();const t=e.touches[0];this.dragCurrentPosition={x:t.clientX,y:t.clientY},this.updateDragElement(t.clientX,t.clientY);const s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,l=t.clientY-s.top-2.5*this.mouseCellSize,n=Math.floor(i/this.mouseCellSize),r=Math.floor(l/this.mouseCellSize),c=this.getBlockPlacementOffset(this.selectedBlock.shape),h=r-c.row,d=n-c.col,m=d*this.mouseCellSize,u=h*this.mouseCellSize;m>=0&&m<=s.width&&u>=0&&u<=s.height?(this.previewPosition={row:h,col:d},this.drawBoard()):(this.previewPosition=null,this.drawBoard())}handleGlobalTouchEnd(e){if(this.isGameOver||!this.isDragging||!this.selectedBlock)return;e.preventDefault();const t=e.changedTouches[0],s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,l=t.clientY-s.top-2.5*this.mouseCellSize,n=Math.floor(i/this.mouseCellSize),r=Math.floor(l/this.mouseCellSize),c=this.getBlockPlacementOffset(this.selectedBlock.shape),h=r-c.row,d=n-c.col,m=d*this.mouseCellSize,u=h*this.mouseCellSize;m>=0&&m<=s.width&&u>=0&&u<=s.height&&(this.canPlaceBlock(h,d)?this.placeBlock(h,d):this.effectsManager.onError()),this.cleanupDrag()}handleGlobalTouchCancel(e){e.cancelable&&e.preventDefault(),this.cleanupDrag()}createDragElement(){this.dragBlockElement&&this.dragBlockElement.remove(),this.dragBlockElement=null}updateDragElement(e,t){}drawBlockOnCanvas(e,t,s){const i=s/Math.max(t.shape.length,t.shape[0].length);e.fillStyle=t.color,e.strokeStyle=this.darkenColor(t.color),e.lineWidth=1;for(let o=0;o<t.shape.length;o++)for(let a=0;a<t.shape[o].length;a++)if(t.shape[o][a]===1){const l=a*i,n=o*i;e.fillRect(l,n,i,i),e.strokeRect(l,n,i,i)}}darkenColor(e){const t=e.replace("#",""),s=Math.max(0,parseInt(t.substr(0,2),16)-30),i=Math.max(0,parseInt(t.substr(2,2),16)-30),o=Math.max(0,parseInt(t.substr(4,2),16)-30);return`#${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`}getThemeColor(e){try{const t=getComputedStyle(document.documentElement).getPropertyValue(e).trim();if(!t)throw new Error(`Theme color variable '${e}' not found`);return t}catch(t){throw console.error(`Failed to get theme color '${e}':`,t),new Error(`Theme color '${e}' is required but not available`)}}getClearGlowColor(){try{return this.getThemeColor("--clear-glow-color")}catch{return{light:"#00ff00",dark:"#ff4444",wood:"#00aaff"}[this.currentTheme]||"#00ff00"}}cleanupDrag(){this.isDragging=!1,this.dragStartPosition=null,this.dragCurrentPosition=null,this.previewPosition=null,this.dragBlockElement&&(this.dragBlockElement.remove(),this.dragBlockElement=null),this.drawBoard()}handleBlockSelected(e){this.selectedBlock=e.detail.block,this.previewPosition=null,this.drawBoard()}handleBlockDragStart(e){const{block:t,touch:s}=e.detail;this.selectedBlock=t,this.isDragging=!0,this.dragStartPosition={x:s.clientX,y:s.clientY},this.dragCurrentPosition={x:s.clientX,y:s.clientY},this.createDragElement();const i=this.canvas.getBoundingClientRect(),o=s.clientX-i.left,a=s.clientY-i.top,l=Math.floor(o/this.mouseCellSize),n=Math.floor(a/this.mouseCellSize),r=this.getBlockPlacementOffset(t.shape),c=n-r.row,h=l-r.col;this.previewPosition={row:c,col:h},this.drawBoard()}canPlaceBlock(e,t){return!this.selectedBlock||(this.board||(console.error("canPlaceBlock: Board is undefined! Reinitializing..."),this.board=this.initializeBoard(),this.updatePlaceabilityIndicators()),!this.blockManager.canPlaceBlock(this.selectedBlock,e,t,this.board))?!1:this.deadPixelsManager&&this.deadPixelsManager.isEnabled()?this.deadPixelsManager.canPlaceBlockWithDeadPixels(this.selectedBlock,e,t,this.board):!0}generateNewBlocks(){const e=this.blockManager.generateRandomBlocks(3,"all",this.difficultyManager);this.blockPalette.updateBlocks(e),this.updatePlaceabilityIndicators(),this.autoSelectNextBlock()}autoSelectNextBlock(){if(this.blockManager.currentBlocks.length>0){const e=this.blockManager.currentBlocks[0];this.selectedBlock=e,this.blockPalette.selectBlockById(e.id)}}toggleCell(e,t){this.board[e][t]=this.board[e][t]===0?1:0}drawBoard(){if(this.cellSize===0||this.canvas.width===0)return;const e=this.ctx,t=this.actualCellSize||this.cellSize;e.clearRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--board-bg"),e.fillRect(0,0,this.canvas.width,this.canvas.height),e.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--grid-line"),e.lineWidth=1;const s=this.canvas.width,i=this.canvas.height;for(let o=0;o<=this.boardSize;o++){const a=Math.round(o*t);e.beginPath(),e.moveTo(a,0),e.lineTo(a,i),e.stroke()}for(let o=0;o<=this.boardSize;o++){const a=Math.round(o*t);e.beginPath(),e.moveTo(0,a),e.lineTo(s,a),e.stroke()}e.lineWidth=2;for(let o=0;o<=3;o++){const a=Math.round(o*3*t),l=Math.round(o*3*t);e.beginPath(),e.moveTo(a,0),e.lineTo(a,i),e.stroke(),e.beginPath(),e.moveTo(0,l),e.lineTo(s,l),e.stroke()}if(!this.board||!Array.isArray(this.board)){if(console.error("EMERGENCY: drawBoard - Board is not initialized properly, reinitializing..."),this.board=this.initializeBoard(),!this.board){console.error("FATAL: Could not initialize board in drawBoard");return}this.updatePlaceabilityIndicators()}if(this.deadPixelsManager&&this.deadPixelsManager.isEnabled()){const o=this.deadPixelsManager.getDeadPixels(),a=getComputedStyle(document.documentElement).getPropertyValue("--board-bg").trim();o.forEach(({row:l,col:n})=>{const r=Math.round(n*t)+1,c=Math.round(l*t)+1,h=Math.round(t)-2;e.fillStyle=a,e.fillRect(r,c,h,h),e.save(),e.strokeStyle="rgba(128, 128, 128, 0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(r,c),e.lineTo(r+h,c+h),e.moveTo(r+h,c),e.lineTo(r,c+h),e.stroke(),e.restore()})}e.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--block-color");for(let o=0;o<this.boardSize;o++){if(!this.board[o]||!Array.isArray(this.board[o])){console.warn(`drawBoard: Board row ${o} is not initialized properly`);continue}for(let a=0;a<this.boardSize;a++){const l=this.deadPixelsManager&&this.deadPixelsManager.isDeadPixel(o,a);if(this.board[o][a]===1&&!l){const n=Math.round(a*t)+1,r=Math.round(o*t)+1,c=Math.round(t)-2,h=this.petrificationManager.getGridCellState(o,a);if(h.petrified)e.fillStyle="#404040";else if(h.warning==="3s"){const d=Math.sin(Date.now()/150)*.5+.5;e.fillStyle=`rgba(255, 100, 100, ${.5+d*.5})`}else if(h.warning==="7s"){const d=Math.sin(Date.now()/1e3)*.3+.7;e.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--block-color"),e.globalAlpha=d}else e.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--block-color"),e.globalAlpha=1;if(e.fillRect(n,r,c,c),e.globalAlpha=1,e.strokeStyle=h.petrified?"#202020":getComputedStyle(document.documentElement).getPropertyValue("--block-border"),e.lineWidth=h.petrified?2:1,e.strokeRect(n,r,c,c),h.petrified){e.save(),e.strokeStyle="rgba(150, 200, 255, 0.3)",e.lineWidth=1;for(let d=0;d<3;d++)e.beginPath(),e.moveTo(n+d*(c/3),r),e.lineTo(n,r+d*(c/3)),e.stroke(),e.beginPath(),e.moveTo(n+c,r+d*(c/3)),e.lineTo(n+d*(c/3),r+c),e.stroke();e.restore()}}}}if(this.selectedBlock&&this.previewPosition&&(this.drawPreviewBlock(),this.difficulty==="easy"||this.difficulty==="normal")){const o=this.previewPosition.row,a=this.previewPosition.col;if(this.canPlaceBlock(o,a)){const l=this.blockManager.placeBlock(this.selectedBlock,o,a,this.board),n=this.scoringSystem.checkForCompletedLines(l);(n.rows.length||n.columns.length||n.squares.length)&&this.drawClearingBlockGlow(n,{subtle:!0})}}this.difficultyManager.isHintsEnabled()&&this.hintSystem.drawHints(e),this.pendingClears&&this.drawClearingBlockGlow(this.pendingClears)}toggleTheme(){const e=["light","dark","wood"],s=(e.indexOf(this.currentTheme)+1)%e.length;this.applyTheme(e[s]),this.drawBoard()}selectTheme(e){this.applyTheme(e)}drawPreviewBlock(){if(!this.selectedBlock||!this.previewPosition)return;const e=this.ctx,t=this.actualCellSize||this.cellSize,s=this.selectedBlock.shape,i=this.previewPosition.row,o=this.previewPosition.col,a=this.canPlaceBlock(i,o);e.fillStyle=a?this.selectedBlock.color+"80":"#ff000080",e.strokeStyle=a?this.selectedBlock.color:"#ff0000",e.lineWidth=2;for(let l=0;l<s.length;l++)for(let n=0;n<s[l].length;n++)if(s[l][n]===1){const r=o+n,c=i+l;if(r>=0&&r<this.boardSize&&c>=0&&c<this.boardSize){const h=Math.round(r*t)+1,d=Math.round(c*t)+1,m=Math.round(t)-2;e.fillRect(h,d,m,m),e.strokeRect(h,d,m,m)}}}checkLineClears(){if(this.pendingClears){console.log("Skipping line clear check - animation in progress");return}if(this.pendingClears&&this.pendingClearsTimestamp&&Date.now()-this.pendingClearsTimestamp>5e3&&(console.warn("Pending clears stuck for too long, resetting..."),this.pendingClears=null,this.pendingClearResult=null,this.pendingClearsTimestamp=null),!this.board||!Array.isArray(this.board)){console.error("Invalid board state in checkLineClears, reinitializing..."),this.board=this.initializeBoard();return}const e=this.scoringSystem.checkForCompletedLines(this.board);e.rows.length>0||e.columns.length>0||e.squares.length>0?(console.log("Lines detected for clearing:",e),this.updateScoreForClears(e),this.updateUI(),this.showImmediateClearFeedback(e),this.startLineClearAnimation(e)):(console.log("No lines detected for clearing"),this.scoringSystem.resetStreak(),this.updateUI())}updateScoreForClears(e){console.log("updateScoreForClears called with:",e);const t=this.difficultyManager.getScoreMultiplier(),s=this.scoringSystem.calculateScoreForClears(e,t);console.log("Score calculation result:",s),this.score=this.score+s.scoreGained,this.scoringSystem.score=this.score,this.scoringSystem.updateLevelFromScore(),this.level=this.scoringSystem.getLevel();const i=e.rows.length+e.columns.length+e.squares.length;i>0&&(this.scoringSystem.rowsClearedCount+=e.rows.length,this.scoringSystem.columnsClearedCount+=e.columns.length,this.scoringSystem.squaresClearedCount+=e.squares.length,this.scoringSystem.linesCleared+=i,s.isComboEvent?(this.scoringSystem.combo++,this.scoringSystem.maxCombo=Math.max(this.scoringSystem.maxCombo,this.scoringSystem.combo),this.scoringSystem.totalCombos++,this.scoringSystem.maxTotalCombos=Math.max(this.scoringSystem.maxTotalCombos,this.scoringSystem.totalCombos),this.scoringSystem.comboActivations++,this.scoringSystem.streakCount++,this.scoringSystem.maxStreakCount=Math.max(this.scoringSystem.maxStreakCount,this.scoringSystem.streakCount)):this.scoringSystem.combo=0),this.pendingClearResult={clearedLines:e,scoreGained:s.scoreGained,isCombo:s.isComboEvent,combo:this.scoringSystem.getCombo()},this.lastScoreInfo=s,this.showPointBreakdown(s,e),console.log("Score updated immediately. New score:",this.score,"New level:",this.level)}startLineClearAnimation(e){console.log("Starting line clear animation for:",e),this.pendingClearsTimestamp=Date.now(),this.highlightClearingBlocks(e),this.clearTimeoutId=setTimeout(()=>{console.log("Timeout reached, calling completeLineClear"),this.completeLineClear(e)},750),this.safetyTimeoutId=setTimeout(()=>{this.pendingClears&&(console.warn("Safety timeout reached - forcing line clear completion"),this.forceCompleteLineClear(e))},2e3)}showImmediateClearFeedback(e){this.pendingClears=e,this.pendingClearsTimestamp=Date.now(),this.ctx.save();const t=this.getClearGlowColor();this.ctx.fillStyle=t,this.ctx.globalAlpha=.2,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalAlpha=1,this.ctx.restore(),this.canvas.style.border=`1px solid ${t}`,this.canvas.style.boxShadow=`0 0 5px ${t}`,setTimeout(()=>{this.canvas.style.border="",this.canvas.style.boxShadow=""},300),this.drawBoard();const s=this.canvas.width/2,i=this.canvas.height/2;this.showQuickClearNotification(s,i,e)}drawClearingBlockGlow(e,t={}){const{subtle:s=!1}=t;this.ctx.save();const i=this.actualCellSize||this.cellSize,o=this.getClearGlowColor();this.ctx.shadowColor=o,this.ctx.shadowBlur=s?2:4,this.ctx.strokeStyle=o,this.ctx.lineWidth=s?.5:1,this.ctx.globalAlpha=s?.2:.4,e.rows.forEach(a=>{for(let l=0;l<this.boardSize;l++)if(this.board[a][l]===1){const n=l*i,r=a*i,c=s?3:2;this.ctx.strokeRect(n+c,r+c,i-c*2,i-c*2)}}),e.columns.forEach(a=>{for(let l=0;l<this.boardSize;l++)if(this.board[l][a]===1){const n=a*i,r=l*i,c=s?3:2;this.ctx.strokeRect(n+c,r+c,i-c*2,i-c*2)}}),e.squares.forEach(a=>{const l=a.row*3,n=a.col*3;for(let r=0;r<3;r++)for(let c=0;c<3;c++){const h=l+r,d=n+c;if(this.board[h][d]===1){const m=d*i,u=h*i,f=s?3:2;this.ctx.strokeRect(m+f,u+f,i-f*2,i-f*2)}}}),this.ctx.shadowBlur=0,this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=s?.5:.75,this.ctx.globalAlpha=s?.25:.5,e.rows.forEach(a=>{for(let l=0;l<this.boardSize;l++)if(this.board[a][l]===1){const n=l*i,r=a*i,c=s?5:4;this.ctx.strokeRect(n+c,r+c,i-c*2,i-c*2)}}),e.columns.forEach(a=>{for(let l=0;l<this.boardSize;l++)if(this.board[l][a]===1){const n=a*i,r=l*i,c=s?5:4;this.ctx.strokeRect(n+c,r+c,i-c*2,i-c*2)}}),e.squares.forEach(a=>{const l=a.row*3,n=a.col*3;for(let r=0;r<3;r++)for(let c=0;c<3;c++){const h=l+r,d=n+c;if(this.board[h][d]===1){const m=d*i,u=h*i,f=s?5:4;this.ctx.strokeRect(m+f,u+f,i-f*2,i-f*2)}}}),this.ctx.restore()}showQuickClearNotification(e,t,s){this.ctx.save();const i=s.rows.length+s.columns.length+s.squares.length;let o="";i===1?s.rows.length>0?o="ROW!":s.columns.length>0?o="COLUMN!":s.squares.length>0&&(o="SQUARE!"):o=`${i} CLEARS!`,this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(e-80,t-20,160,40);const a=this.getClearGlowColor();this.ctx.strokeStyle=a,this.ctx.lineWidth=3,this.ctx.strokeRect(e-80,t-20,160,40),this.ctx.fillStyle=a,this.ctx.font="bold 24px Arial",this.ctx.textAlign="center",this.ctx.fillText(o,e,t+8),this.ctx.restore(),setTimeout(()=>{this.drawBoard()},400)}highlightClearingBlocks(e){this.drawBoard();const t=this.ctx,s=this.actualCellSize||this.cellSize,i=this.getClearGlowColor();t.save(),t.globalAlpha=.7,e.rows.forEach(o=>{t.fillStyle=i,t.fillRect(0,o*s,this.canvas.width,s)}),e.columns.forEach(o=>{t.fillStyle=i,t.fillRect(o*s,0,s,this.canvas.height)}),e.squares.forEach(o=>{t.fillStyle=i;const a=o.col*3*s,l=o.row*3*s;t.fillRect(a,l,3*s,3*s)}),t.restore()}completeLineClear(e){var n;console.log("completeLineClear called with:",e);let t,s;try{if(console.log("Clearing lines from board..."),t=this.scoringSystem.clearLinesFromBoard(this.board,e),console.log("Lines cleared from board, result:",t),t&&t.board)this.board=t.board,this.pendingClears=null,this.pendingClearsTimestamp=null,this.clearTimeoutId&&(clearTimeout(this.clearTimeoutId),this.clearTimeoutId=null),this.safetyTimeoutId&&(clearTimeout(this.safetyTimeoutId),this.safetyTimeoutId=null);else{console.error("Failed to clear lines from board, keeping pending state");return}this.petrificationManager.thawAll(),this.petrificationManager.updateBoardTracking(this.board);const r=this.pendingClearResult;r?s=r.combo:(console.warn("No pendingClearResult found - score was not pre-calculated!"),s=this.scoringSystem.getCombo()),this.pendingClearResult=null,console.log("Line clear completed. Score was already updated. Current score:",this.score,"Current level:",this.level)}catch(r){console.error("Error during line clear completion:",r),console.log("Attempting recovery from line clear error...");try{const c=this.scoringSystem.clearLinesFromBoard(this.board,e);c&&c.board?(this.board=c.board,this.pendingClears=null,this.pendingClearsTimestamp=null,this.pendingClearResult=null,console.log("Recovery successful, lines cleared")):console.error("Recovery failed, keeping pending state for manual intervention")}catch(c){console.error("Recovery attempt also failed:",c)}return}this.createLineClearEffect(e);const i=this.canvas.width/2,o=this.canvas.height/2;this.effectsManager.onLineClear(i,o,e);const a=storedResult?storedResult.scoreGained:0,l=storedResult?storedResult.isCombo:!1;this.createScorePopup(i,o,a,e,l,s,((n=this.storage.loadSettings())==null?void 0:n.comboDisplayMode)||"cumulative"),s>=1&&(this.createComboEffect(s,i,o+50),this.effectsManager.onCombo(i,o+50,s)),this.updateUI(),this.updatePlaceabilityIndicators(),setTimeout(()=>{this.checkLineClears()},200)}forceCompleteLineClear(e){console.log("Force completing line clear for:",e);try{this.clearTimeoutId&&(clearTimeout(this.clearTimeoutId),this.clearTimeoutId=null),this.safetyTimeoutId&&(clearTimeout(this.safetyTimeoutId),this.safetyTimeoutId=null);const t=this.scoringSystem.clearLinesFromBoard(this.board,e);t&&t.board?(this.board=t.board,this.pendingClears=null,this.pendingClearsTimestamp=null,this.pendingClearResult=null,this.petrificationManager.thawAll(),this.petrificationManager.updateBoardTracking(this.board),this.updateUI(),this.updatePlaceabilityIndicators(),console.log("Force clear completed successfully")):(console.error("Force clear failed - using emergency reset"),this.resetStuckUIState())}catch(t){console.error("Force clear error:",t),this.resetStuckUIState()}}newGame(){this.score>0&&this.checkHighScore(),this.board=this.initializeBoard(),this.scoringSystem.reset(),this.petrificationManager.resetAll(),this.petrificationManager.resetStats(),this.deadPixelsManager&&this.deadPixelsManager.isEnabled()&&this.deadPixelsManager.generateDeadPixels(this.boardSize),this.score=0,this.level=1,this.selectedBlock=null,this.previewPosition=null,this.isGameOver=!1,this.isInitialized=!0;const e=this.storage.loadSettings();this.comboModeActive=e.comboDisplayMode||"cumulative",this.comboModesUsed=new Set,this.blockPalette&&this.blockPalette.stopTimeoutChecking&&this.blockPalette.stopTimeoutChecking(),this.blockPalette&&this.blockPalette.resetDragState&&this.blockPalette.resetDragState(),this.previousScore=0,this.previousLevel=1,this.previousCombo=0,this.previousTotalCombos=0,this.generateNewBlocks(),this.drawBoard(),this.updateUI(),this.storage.clearGameState()}restartWithDifficulty(e){console.log(`Restarting game with difficulty: ${e}`),this.difficultyManager.setDifficulty(e),this.updateDifficultyButton(),this.timerSystem.initialize(),this.timerSystem.start(),this.hintSystem.reset(),this.newGame()}updateUI(){const e=document.getElementById("score"),t=document.getElementById("level"),s=document.getElementById("combo"),i=document.getElementById("combo-label"),o=document.getElementById("speed-bonus"),a=document.getElementById("speed-bonus-value"),l=this.scoringSystem.getCombo(),n=this.scoringSystem.getTotalCombos(),r=this.scoringSystem.getSpeedStats(),h=this.storage.loadSettings().comboDisplayMode||"cumulative";if(this.comboModeActive=h,this.comboModesUsed.add(h),this.previousScore===0&&this.score>0?this.successModeEnabled&&this.animateFirstScore(e):this.score>this.previousScore&&this.animateScoreIncrease(e),this.level>this.previousLevel){this.animateLevelUp(t);const m=this.scoringSystem.applyEmptyGridBonus(this.board);m>0&&this.showEmptyGridBonus(m)}const d=this.previousTotalCombos||0;if(h==="cumulative"?n>d&&n>=1&&this.animateComboHit(s):l>this.previousCombo&&l>=1&&this.animateComboHit(s),e.textContent=this.score,t.textContent=this.level,i&&(i.textContent="Combo"),h==="cumulative"?s.textContent=n:s.textContent=l,o&&a)if(this.storage.loadSettings().showSpeedBonus===!0&&r.totalSpeedBonus>0){if(o.style.display="flex",a.textContent=r.totalSpeedBonus,r.speedBonuses.length>0){const f=r.speedBonuses[r.speedBonuses.length-1];Date.now()-f.timestamp<2e3&&(o.classList.add("speed-pulse"),setTimeout(()=>{o.classList.remove("speed-pulse")},600))}}else o.style.display="none";this.previousScore=this.score,this.previousLevel=this.level,this.previousCombo=l,this.previousTotalCombos=n,this.updateHintControls(),this.renderPersonalBests()}renderPersonalBests(){try{const e=document.getElementById("personal-bests");if(!e)return;if(!(this.storage.loadSettings().showHighScore===!0)){e.style.display="none";return}const i=this.storage.getBestScoresByDifficulty();e.innerHTML=`
                <span class="pb-item"><span class="pb-label">Easy</span><span class="pb-value">${(i.easy||0).toLocaleString()}</span></span>
                <span class="pb-item"><span class="pb-label">Normal</span><span class="pb-value">${(i.normal||0).toLocaleString()}</span></span>
                <span class="pb-item"><span class="pb-label">Hard</span><span class="pb-value">${(i.hard||0).toLocaleString()}</span></span>
                <span class="pb-item"><span class="pb-label">Expert</span><span class="pb-value">${(i.expert||0).toLocaleString()}</span></span>
            `,e.style.display="inline-flex"}catch(e){console.warn("renderPersonalBests failed:",e)}this.updateUtilityBarState()}showPointBreakdown(e,t){if(!e||e.scoreGained===0)return;let s=document.getElementById("point-breakdown");s||(s=document.createElement("div"),s.id="point-breakdown",s.className="point-breakdown",document.querySelector(".game-info").appendChild(s));const i=e.breakdown||{},o=[];if(i.linePoints>0){const a=t.rows.length+t.columns.length;o.push(`${a} Line${a>1?"s":""}: +${i.linePoints}`)}if(i.squarePoints>0){const a=t.squares.length;o.push(`${a} Square${a>1?"s":""}: +${i.squarePoints}`)}i.comboBonus>0&&o.push(`Combo Bonus: +${i.comboBonus}`),o.length>0&&(s.innerHTML=o.join("<br>"),s.style.display="block",s.style.opacity="1",s.style.transition="all 0.3s ease-out",s.style.transform="scale(1.1)",s.style.color=this.getClearGlowColor(),setTimeout(()=>{s.style.opacity="0",s.style.transform="scale(1)",setTimeout(()=>{s.style.display="none"},300)},3e3)),this.showFloatingScore(e.scoreGained,e.isComboEvent)}showFloatingScore(e,t=!1){const i=document.getElementById("score").getBoundingClientRect(),o=this.canvas.getBoundingClientRect(),a=i.left+i.width/2-o.left,l=i.top+i.height/2-o.top,n=document.createElement("div");n.className="floating-score",n.textContent=`+${e}`,n.style.position="absolute",n.style.left=`${a}px`,n.style.top=`${l}px`,n.style.color=t?"#ff6600":this.getClearGlowColor(),n.style.fontSize="2rem",n.style.fontWeight="900",n.style.textShadow=`0 0 10px ${t?"#ff6600":this.getClearGlowColor()}`,n.style.pointerEvents="none",n.style.zIndex="1000",n.style.transition="all 1.5s ease-out",this.canvas.parentElement.appendChild(n),setTimeout(()=>{n.style.transform="translateY(-60px) scale(1.2)",n.style.opacity="0"},100),setTimeout(()=>{n.parentElement&&n.parentElement.removeChild(n)},1600)}showPlacementPointsFeedback(e,t,s){if(!(this.storage.loadSettings().showPlacementPoints===!0))return;const a=this.actualCellSize||this.cellSize,l=s*a+a/2,n=t*a+a/2,r=document.createElement("div");r.className="floating-placement-points",r.textContent=`+${e}`,r.style.position="absolute",r.style.left=`${l}px`,r.style.top=`${n}px`,r.style.color="#00ff88",r.style.fontSize="1.2rem",r.style.fontWeight="700",r.style.textShadow="0 0 8px #00ff88",r.style.pointerEvents="none",r.style.zIndex="1000",r.style.transition="all 1.2s ease-out",r.style.transform="translate(-50%, -50%) scale(0.8)",r.style.opacity="0",this.canvas.parentElement.appendChild(r),setTimeout(()=>{r.style.transform="translate(-50%, -50%) scale(1.1)",r.style.opacity="1"},50),setTimeout(()=>{r.style.transform="translate(-50%, -80px) scale(0.9)",r.style.opacity="0"},800),setTimeout(()=>{r.parentElement&&r.parentElement.removeChild(r)},1300)}showEmptyGridBonus(e){const t=this.canvas.width/2,s=this.canvas.height/2,i=document.createElement("div");i.className="floating-empty-grid-bonus",i.textContent=`Empty Grid Bonus: +${e}`,i.style.position="absolute",i.style.left=`${t}px`,i.style.top=`${s}px`,i.style.color="#00ff88",i.style.fontSize="1.8rem",i.style.fontWeight="900",i.style.textShadow="0 0 15px #00ff88, 0 0 30px #00ff88",i.style.pointerEvents="none",i.style.zIndex="1001",i.style.transition="all 2.5s ease-out",i.style.transform="translate(-50%, -50%) scale(0.8)",i.style.opacity="0",i.style.textAlign="center",i.style.whiteSpace="nowrap",this.canvas.parentElement.appendChild(i),setTimeout(()=>{i.style.transform="translate(-50%, -50%) scale(1.3)",i.style.opacity="1"},100),setTimeout(()=>{i.style.transform="translate(-50%, -120px) scale(1.1)",i.style.opacity="0"},1500),setTimeout(()=>{i.parentElement&&i.parentElement.removeChild(i)},2600),this.successModeEnabled&&this.effectsManager.particles.createEmptyGridBonusEffect(t,s),this.effectsManager.sound&&this.effectsManager.sound.play("emptyGridBonus"),this.effectsManager.haptic&&this.effectsManager.haptic.onEmptyGridBonus()}updateHintControls(){const e=document.getElementById("hint-controls"),t=document.getElementById("hint-btn");if(e&&t){const s=this.difficultyManager.isHintsEnabled();if(e.style.display=s?"block":"none",s){const i=this.hintSystem.getHintStatus();t.disabled=!i.available,i.active?t.textContent="ðŸ’¡ Hint On":i.available?t.textContent="ðŸ’¡ Hint Off":t.textContent=`ðŸ’¡ Hint (${Math.ceil(i.cooldownRemaining/1e3)}s)`}}this.updateUtilityBarState()}updateUtilityBarState(){const e=document.getElementById("utility-bar");if(!e)return;const t=document.getElementById("timer-display"),s=document.getElementById("speed-bonus"),i=document.getElementById("hint-controls"),o=document.getElementById("personal-bests");t&&t.style.display!=="none"||s&&s.style.display!=="none"||i&&i.style.display!=="none"||o&&o.style.display!=="none"?e.classList.add("has-content"):e.classList.remove("has-content"),this.updateSlotActiveState("hint-slot",i),this.updateSlotActiveState("timer-slot",t),this.updateSlotActiveState("personal-best-slot",o),this.updateSlotActiveState("speed-bonus-slot",s)}updateSlotActiveState(e,t){const s=document.getElementById(e);if(!s)return;t&&t.style.display!=="none"?s.classList.add("active"):s.classList.remove("active")}updateTimerDisplay(){const e=document.getElementById("timer-display"),t=document.getElementById("timer");if(e&&t&&this.timerSystem){const s=this.difficultyManager.getTimeLimit()!==null;if(e.style.display=s?"block":"none",s){const i=this.timerSystem.getTimeRemaining();t.textContent=this.timerSystem.formatTime(i),e.classList.remove("warning","critical"),this.timerSystem.isCriticalTime()?e.classList.contains("critical")||(e.classList.add("critical"),this.effectsManager.sound.play("timeCritical")):this.timerSystem.isWarningTime()&&(e.classList.contains("warning")||(e.classList.add("warning"),this.effectsManager.sound.play("timeWarning"))),t.style.color="",t.style.textShadow="",t.style.animation=""}}this.updateUtilityBarState()}handleTimeUp(){this.effectsManager.onError(),this.gameOver()}showTimeBonus(e){this.effectsManager.onScoreGain(e);const t=this.canvas;this.ctx;const s=t.width/2,i=t.height/2;this.effectsManager.particles.createFloatingText(s,i-50,`+${e}s`,this.getClearGlowColor(),2e3)}updateDifficultyButton(){const e=document.getElementById("difficulty-btn");if(e){const t=this.difficultyManager.getCurrentDifficulty(),s=this.difficultyManager.getDifficultyInfo();e.classList.remove("easy","normal","hard","expert"),e.classList.add(t),e.textContent=s.name,e.title=`Current difficulty: ${s.name} - ${s.description}`}}createLineClearEffect(e){const t=this.getClearGlowColor();this.ctx.fillStyle=t,this.ctx.globalAlpha=.8,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalAlpha=1,setTimeout(()=>{this.ctx.fillStyle="#ffffff",this.ctx.globalAlpha=.6,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalAlpha=1,setTimeout(()=>{this.drawBoard()},150)},100)}createScorePopup(e,t,s,i={rows:[],columns:[],squares:[]},o=!1,a=0,l="streak"){var b,v,S;this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(e-60,t-20,120,40);const n=this.getClearGlowColor();this.ctx.strokeStyle=n,this.ctx.lineWidth=2,this.ctx.strokeRect(e-60,t-20,120,40);const r=(((b=i==null?void 0:i.rows)==null?void 0:b.length)||0)+(((v=i==null?void 0:i.columns)==null?void 0:v.length)||0),c=((S=i==null?void 0:i.squares)==null?void 0:S.length)||0,h=[];r>0&&h.push(`${r} line${r>1?"s":""}`),c>0&&h.push(`${c} square${c>1?"s":""}`);const d=h.length?h.join(" + "):"Placement";this.ctx.fillStyle=n,this.ctx.font="bold 22px Arial",this.ctx.textAlign="center",this.ctx.fillText(`+${s}`,e,t),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 14px Arial";const m=o?l==="cumulative"?` â€¢ COMBO x${a} (total)`:` â€¢ COMBO x${a}`:"";this.ctx.fillText(`${d}${m}`,e,t+18),this.ctx.restore();let u=0;const f=()=>{if(u<60){this.ctx.save(),this.ctx.globalAlpha=1-u/60,this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(e-70,t-24-u*2,140,48),this.ctx.strokeStyle=n,this.ctx.lineWidth=2,this.ctx.strokeRect(e-70,t-24-u*2,140,48),this.ctx.fillStyle=n,this.ctx.font="bold 22px Arial",this.ctx.textAlign="center",this.ctx.fillText(`+${s}`,e,t-4-u*2),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 14px Arial";const k=o?l==="cumulative"?` â€¢ COMBO x${a} (total)`:` â€¢ COMBO x${a}`:"";this.ctx.fillText(`${d}${k}`,e,t+14-u*2),this.ctx.restore(),u++,requestAnimationFrame(f)}else this.drawBoard()};setTimeout(()=>{requestAnimationFrame(f)},200)}createComboEffect(e,t,s){if(!this.successModeEnabled)return;this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(t-80,s-15,160,30),this.ctx.strokeStyle="#ff6600",this.ctx.lineWidth=2,this.ctx.strokeRect(t-80,s-15,160,30),this.ctx.fillStyle="#ff6600",this.ctx.font="bold 24px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${e}x COMBO!`,t,s+5),this.ctx.restore();let i=0;const o=()=>{if(i<60){this.ctx.save();const a=1+Math.sin(i*.3)*.2;this.ctx.scale(a,a),this.ctx.globalAlpha=1-i/60,this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect((t-80)/a,(s-15)/a,160/a,30/a),this.ctx.strokeStyle="#ff6600",this.ctx.lineWidth=2,this.ctx.strokeRect((t-80)/a,(s-15)/a,160/a,30/a),this.ctx.fillStyle="#ff6600",this.ctx.font="bold 24px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${e}x COMBO!`,t/a,(s+5)/a),this.ctx.restore(),i++,requestAnimationFrame(o)}else this.drawBoard()};setTimeout(()=>{requestAnimationFrame(o)},300)}animateFirstScore(e){e.style.transition="all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)",e.style.transform="scale(1.6)";const t=this.getClearGlowColor();e.style.color=t,e.style.textShadow=`0 0 20px ${t}`,setTimeout(()=>{e.style.transform="scale(1.3)"},300),setTimeout(()=>{e.style.transform="scale(1.1)"},500),setTimeout(()=>{e.style.transform="scale(1)",e.style.color="",e.style.textShadow=""},800)}animateScoreIncrease(e){e.style.transition="all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)",e.style.transform="scale(1.3)",e.style.color=this.getClearGlowColor(),e.style.textShadow=`0 0 15px ${this.getClearGlowColor()}`,setTimeout(()=>{e.style.transform="scale(1.1)"},200),setTimeout(()=>{e.style.transform="scale(1)",e.style.color="",e.style.textShadow=""},400)}animateLevelUp(e){e.style.transition="all 0.8s ease-out",e.style.transform="scale(1.4) rotate(5deg)",e.style.color="#ff6600",e.style.textShadow="0 0 15px #ff6600";const t=this.canvas.width/2,s=this.canvas.height/2;this.effectsManager.onLevelUp(t,s),this.showEncouragingLevelMessage(),setTimeout(()=>{e.style.transform="scale(1) rotate(0deg)",e.style.color="",e.style.textShadow=""},800)}showEncouragingLevelMessage(){const e=this.ctx,t=this.canvas.width/2,s=this.canvas.height/2-60,i=this.getEncouragementText();e.save(),e.fillStyle="rgba(0, 0, 0, 0.75)",e.fillRect(t-140,s-24,280,48),e.strokeStyle="#ff6600",e.lineWidth=2,e.strokeRect(t-140,s-24,280,48),e.fillStyle="#ffcc66",e.font="bold 18px Arial",e.textAlign="center",e.fillText(i,t,s+6),e.restore(),setTimeout(()=>this.drawBoard(),1200)}getEncouragementText(){var o,a;const e=this.level,t=((a=(o=this.difficultyManager)==null?void 0:o.getCurrentDifficulty)==null?void 0:a.call(o))||this.difficulty||"normal",s={easy:["Great rhythm! Keep building streaks!","Nice clears! Try planning two moves ahead.","Youâ€™re cruisingâ€”consider Normal soon!"],normal:["Clean plays! Eye the 3x3 squares.","Strong paceâ€”chain those clears!","Feeling comfy? Hard might be fun!"],hard:["Impressive! Combos are your friend.","Great foresightâ€”minimize leftover singles.","Dominating Hard? Expert awaits."],expert:["Elite moves! Stay calm under the clock.","Precision playâ€”keep the board breathable.","Excellent focusâ€”push that high score!"]},i=s[t]||s.normal;return i[(e-1)%i.length]}animateComboHit(e){e.style.transition="all 0.5s ease-out",e.style.transform="scale(1.3)",e.style.color="#ff0066",e.style.textShadow="0 0 12px #ff0066";let t=0;const s=()=>{t<3?(e.style.transform=t%2===0?"scale(1.3)":"scale(1.1)",t++,setTimeout(s,150)):(e.style.transform="scale(1)",e.style.color="",e.style.textShadow="")};setTimeout(s,200)}loadSettings(){const e=this.storage.loadSettings();this.currentTheme=e.theme,this.applyTheme(e.theme),this.comboModeActive=e.comboDisplayMode||"cumulative";const t=e.speedMode||"ignored";if(this.scoringSystem.setSpeedMode(t),this.enableDeadPixels=e.enableDeadPixels||!1,this.deadPixelsIntensity=e.deadPixelsIntensity||0,this.deadPixelsManager){const s=this.deadPixelsManager.isEnabled(),i=this.deadPixelsManager.getIntensity();this.deadPixelsManager.setEnabled(this.enableDeadPixels),this.deadPixelsManager.setIntensity(this.deadPixelsIntensity);const o=this.deadPixelsIntensity!==i;this.enableDeadPixels&&(!s||o)&&(!(this.deadPixelsManager.getDeadPixels().length>0)||o)&&this.deadPixelsManager.generateDeadPixels(this.boardSize),!this.enableDeadPixels&&s&&this.deadPixelsManager.clearDeadPixels()}}loadGameState(){const e=this.storage.loadGameState();e?(console.log("Loading saved game state:",e),this.board=e.board||this.initializeBoard(),this.score=e.score||0,this.level=e.level||1,this.previousScore=this.score,this.previousLevel=this.level,this.previousCombo=0,this.previousTotalCombos=0,this.scoringSystem.score=this.score,this.scoringSystem.level=this.level,e.scoringState&&(this.scoringSystem.linesCleared=e.scoringState.linesCleared||0,this.scoringSystem.combo=e.scoringState.combo||0,this.scoringSystem.maxCombo=e.scoringState.maxCombo||0,this.scoringSystem.rowsClearedCount=e.scoringState.rowsClearedCount||0,this.scoringSystem.columnsClearedCount=e.scoringState.columnsClearedCount||0,this.scoringSystem.squaresClearedCount=e.scoringState.squaresClearedCount||0,this.scoringSystem.comboActivations=e.scoringState.comboActivations||0,this.scoringSystem.pointsBreakdown=e.scoringState.pointsBreakdown||{linePoints:0,squarePoints:0,comboBonusPoints:0}),e.currentBlocks&&(this.blockManager.currentBlocks=e.currentBlocks,this.blockPalette.updateBlocks(e.currentBlocks)),e.selectedBlock&&(this.selectedBlock=e.selectedBlock),e.petrificationState&&this.petrificationManager&&this.petrificationManager.deserialize(e.petrificationState),e.deadPixelsState&&this.deadPixelsManager&&this.deadPixelsManager.deserialize(e.deadPixelsState),this.updatePlaceabilityIndicators(),console.log("Game state loaded successfully")):(console.log("No saved game state found - preserving current board state"),(!this.board||!Array.isArray(this.board))&&(this.board=this.initializeBoard()))}saveGameState(){if(!(this.score>0||this.board&&this.board.some(s=>s.some(i=>i===1))||this.blockManager.currentBlocks&&this.blockManager.currentBlocks.length>0)){console.log("No game progress to save, skipping save");return}const t={board:this.board,score:this.score,level:this.level,currentBlocks:this.blockManager.currentBlocks,selectedBlock:this.selectedBlock,scoringState:{linesCleared:this.scoringSystem.linesCleared,combo:this.scoringSystem.combo,maxCombo:this.scoringSystem.maxCombo,rowsClearedCount:this.scoringSystem.rowsClearedCount,columnsClearedCount:this.scoringSystem.columnsClearedCount,squaresClearedCount:this.scoringSystem.squaresClearedCount,comboActivations:this.scoringSystem.comboActivations,pointsBreakdown:this.scoringSystem.pointsBreakdown},petrificationState:this.petrificationManager?this.petrificationManager.serialize():null,deadPixelsState:this.deadPixelsManager?this.deadPixelsManager.serialize():null};console.log("Saving game state:",t),this.storage.saveGameState(t),console.log("Game state saved successfully")}loadSettings(){if(this.storage){const e=this.storage.loadSettings();this.currentTheme=e.theme||"light",this.soundEnabled=e.soundEnabled===!0,this.animationsEnabled=e.animationsEnabled!==!1,this.difficulty=e.difficulty||"normal",this.autoSave=e.autoSave!==!1,this.enableHints=e.enableHints||!1,this.enableTimer=e.enableTimer||!1,this.enablePetrification=e.enablePetrification||!1,this.showPoints=e.showPoints||!1,this.showPlacementPoints=e.showPlacementPoints||!1,this.particlesEnabled=e.particlesEnabled!==!1,this.hapticEnabled=e.hapticEnabled!==!1,this.enablePrizeRecognition=e.enablePrizeRecognition!==!1,this.successModeEnabled=e.successModeEnabled!==!1,this.petrificationManager&&this.petrificationManager.setEnabled(this.enablePetrification);const t=localStorage.getItem("blockdoku_pending_difficulty");t&&(this.difficulty=t,localStorage.removeItem("blockdoku_pending_difficulty")),this.applyTheme(this.currentTheme),this.difficultyManager&&this.difficultyManager.setDifficulty(this.difficulty),this.applyEffectsSettings(),this.updateBlockPointsDisplay()}}saveSettings(){const e={theme:this.currentTheme,soundEnabled:this.soundEnabled,animationsEnabled:this.animationsEnabled,difficulty:this.difficulty,autoSave:this.autoSave,enableHints:this.enableHints,enableTimer:this.enableTimer,showPoints:this.showPoints,showPlacementPoints:this.showPlacementPoints,particlesEnabled:this.particlesEnabled,hapticEnabled:this.hapticEnabled};this.storage&&this.storage.saveSettings(e)}updateBlockPointsDisplay(){const e=this.showPoints||!1;document.querySelectorAll(".block-info").forEach(s=>{e?s.classList.add("show-points"):s.classList.remove("show-points")})}applyEffectsSettings(){this.effectsManager&&this.effectsManager.updateSettings({particles:this.particlesEnabled!==!1,sound:this.soundEnabled===!0,haptic:this.hapticEnabled!==!1})}applyTheme(e){this.currentTheme=e;let t=document.getElementById("theme-css");t||(t=document.createElement("link"),t.rel="stylesheet",t.id="theme-css",document.head.appendChild(t)),t.href=`css/themes/${e}.css`;try{Array.from(document.querySelectorAll('link[rel="stylesheet"]')).filter(a=>(a.getAttribute("href")||"").includes("/assets/wood-")||(a.href||"").includes("/assets/wood-")).forEach(a=>{a.disabled=e!=="wood"})}catch{}const s=document.getElementById("theme-css-light"),i=document.getElementById("theme-css-dark");s&&(s.media="all"),i&&(i.media="all"),document.documentElement.setAttribute("data-theme",e),document.body.className=document.body.className.replace(/light-theme|dark-theme|wood-theme/g,""),document.body.classList.add(`${e}-theme`),this.pendingClears&&(console.log("Clearing pending clears due to theme switch"),this.pendingClears=null,this.pendingClearsTimestamp=null),setTimeout(()=>{this.render()},50),this.saveSettings()}checkHighScore(){const e=this.getStats();return this.storage.saveStatistics(e),this.storage.isHighScore(e.score)?(this.storage.saveHighScore(e),!0):!1}getHighScores(){return this.storage.getHighScores()}getStatistics(){return this.storage.loadStatistics()}gameOver(){if(this.isGameOver)return;this.isGameOver=!0,console.log("Game Over! Final Score:",this.score),this.blockPalette&&this.blockPalette.pauseTimeoutChecking&&this.blockPalette.pauseTimeoutChecking(),this.blockPalette&&this.blockPalette.resetDragState&&this.blockPalette.resetDragState(),this.stopGameLoop();const e=this.getStats();this.checkHighScore(),this.loadHighScores(),this.settingsManager&&this.settingsManager.refreshStatistics&&this.settingsManager.refreshStatistics(),this.showGameOverModal(e),this.saveGameState(),this.storage&&this.storage.clearGameState&&this.storage.clearGameState()}stopGameLoop(){this.gameRunning=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}getPrizeForScore(e){const t=[{minScore:0,maxScore:999,emoji:"ðŸŽ¯",name:"First Steps",message:"Every journey begins with a single step!"},{minScore:1e3,maxScore:2499,emoji:"ðŸŒŸ",name:"Rising Star",message:"You're getting the hang of it!"},{minScore:2500,maxScore:4999,emoji:"ðŸ”¥",name:"Hot Streak",message:"You're on fire! Keep it up!"},{minScore:5e3,maxScore:9999,emoji:"ðŸ’Ž",name:"Diamond Player",message:"Shining bright like a diamond!"},{minScore:1e4,maxScore:19999,emoji:"ðŸ†",name:"Champion",message:"You're a true champion!"},{minScore:2e4,maxScore:49999,emoji:"ðŸ‘‘",name:"Royal Master",message:"Fit for a king or queen!"},{minScore:5e4,maxScore:99999,emoji:"ðŸš€",name:"Rocket Master",message:"You're reaching for the stars!"},{minScore:1e5,maxScore:199999,emoji:"â­",name:"Superstar",message:"You're absolutely stellar!"},{minScore:2e5,maxScore:499999,emoji:"ðŸŽª",name:"Carnival Legend",message:"The carnival has a new legend!"},{minScore:5e5,maxScore:999999,emoji:"ðŸŽ­",name:"Master Performer",message:"A performance worthy of the grandest stage!"},{minScore:1e6,maxScore:1/0,emoji:"ðŸ…",name:"Ultimate Grandmaster",message:"You've achieved the impossible!"}];for(const s of t)if(e>=s.minScore&&e<=s.maxScore)return s;return t[0]}getNextPrizeInfo(e){const t=[{minScore:0,maxScore:999,emoji:"ðŸŽ¯",name:"First Steps"},{minScore:1e3,maxScore:2499,emoji:"ðŸŒŸ",name:"Rising Star"},{minScore:2500,maxScore:4999,emoji:"ðŸ”¥",name:"Hot Streak"},{minScore:5e3,maxScore:9999,emoji:"ðŸ’Ž",name:"Diamond Player"},{minScore:1e4,maxScore:19999,emoji:"ðŸ†",name:"Champion"},{minScore:2e4,maxScore:49999,emoji:"ðŸ‘‘",name:"Royal Master"},{minScore:5e4,maxScore:99999,emoji:"ðŸš€",name:"Rocket Master"},{minScore:1e5,maxScore:199999,emoji:"â­",name:"Superstar"},{minScore:2e5,maxScore:499999,emoji:"ðŸŽª",name:"Carnival Legend"},{minScore:5e5,maxScore:999999,emoji:"ðŸŽ­",name:"Master Performer"},{minScore:1e6,maxScore:1/0,emoji:"ðŸ…",name:"Ultimate Grandmaster"}];for(let s=0;s<t.length;s++)if(e<t[s].minScore)return{nextPrize:t[s],progress:Math.min(100,(e/t[s].minScore*100).toFixed(1)),pointsNeeded:t[s].minScore-e};return null}showGameOverModal(e){var C,E,w,M;const t=document.getElementById("game-over-modal");t&&t.remove();const s=document.createElement("div");s.id="game-over-modal",s.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: Arial, sans-serif;
        `;const i=document.createElement("style");i.textContent=`
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% {
                    transform: translateY(0);
                }
                40% {
                    transform: translateY(-10px);
                }
                60% {
                    transform: translateY(-5px);
                }
            }
        `,document.head.appendChild(i);const o=document.createElement("div");o.style.cssText=`
            background: var(--card-bg, #2c3e50);
            color: var(--text-color, white);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-color, #3498db);
        `;const a=this.storage.isHighScore(e.score),l=this.enablePrizeRecognition!==!1,n=l?this.getPrizeForScore(e.score):null,r=l?this.getNextPrizeInfo(e.score):null,c=((E=(C=e.difficulty)==null?void 0:C.toUpperCase)==null?void 0:E.call(C))||this.difficulty.toUpperCase(),h=e.difficultyMultiplier||((M=(w=this.difficultyManager)==null?void 0:w.getScoreMultiplier)==null?void 0:M.call(w))||1,d=e.breakdown||{linePoints:0,squarePoints:0,comboBonusPoints:0,placementPoints:0},m={rows:e.rowClears||0,columns:e.columnClears||0,squares:e.squareClears||0},u=`<p style="margin: 5px 0;">Max Streak: ${e.maxCombo}</p><p style="margin: 5px 0;">Total Combos: ${e.totalCombos||0}</p><p style="margin: 5px 0;">Max Combo Streak: ${e.maxStreakCount||0}</p>`;o.innerHTML=`
			<h2 style="margin: 0 0 20px 0; color: var(--primary-color, #3498db);">Game Over!</h2>
			
			${l?`
			<!-- Prize Section -->
			<div style="margin: 15px 0; padding: 20px; background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,165,0,0.1)); border: 2px solid #ffd700; border-radius: 15px; text-align: center;">
				<div style="font-size: 4em; margin-bottom: 10px; animation: bounce 1s ease-in-out;">${n.emoji}</div>
				<h3 style="margin: 0 0 8px 0; color: #ffd700; font-size: 1.4em; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${n.name}</h3>
				<p style="margin: 0 0 15px 0; color: var(--text-color, white); font-style: italic; font-size: 1.1em;">${n.message}</p>
				${r?`
					<div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,215,0,0.3);">
						<p style="margin: 0 0 8px 0; color: #ffd700; font-size: 0.9em; font-weight: bold;">Next Prize: ${r.nextPrize.emoji} ${r.nextPrize.name}</p>
						<div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 8px; margin: 5px 0;">
							<div style="background: linear-gradient(90deg, #ffd700, #ffed4e); height: 100%; border-radius: 10px; width: ${r.progress}%; transition: width 0.5s ease;"></div>
						</div>
						<p style="margin: 5px 0 0 0; color: var(--text-color, white); font-size: 0.8em;">${r.pointsNeeded.toLocaleString()} points to go!</p>
					</div>
				`:`
					<div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,215,0,0.3);">
						<p style="margin: 0; color: #ffd700; font-size: 0.9em; font-weight: bold;">ðŸ† You've reached the highest tier! ðŸ†</p>
					</div>
				`}
			</div>
			`:""}
			
			<div style="margin: 15px 0;">
				<p style="margin: 5px 0; font-size: 1.2em;"><strong>Final Score: ${e.score}</strong></p>
				<p style="margin: 5px 0;">Level: ${e.level}</p>
				<p style="margin: 5px 0;">Lines Cleared: ${e.linesCleared}</p>
                ${u}
				<p style="margin: 5px 0;">Difficulty: ${c} (x${h})</p>
				${a?'<p style="color: #ffd700; font-weight: bold; margin: 10px 0;">ðŸŽ‰ New High Score! ðŸŽ‰</p>':""}
			</div>
			<div style="text-align: left; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
					<div>
						<h3 style="margin: 0 0 6px 0; color: var(--primary-color, #3498db); font-size: 1em;">Clears</h3>
						<p style="margin: 4px 0;">Rows: <strong>${m.rows}</strong></p>
						<p style="margin: 4px 0;">Columns: <strong>${m.columns}</strong></p>
						<p style="margin: 4px 0;">3x3 Squares: <strong>${m.squares}</strong></p>
					</div>
					<div>
						<h3 style="margin: 0 0 6px 0; color: var(--primary-color, #3498db); font-size: 1em;">Score Breakdown</h3>
						<p style="margin: 4px 0;">Lines: <strong>${d.linePoints.toLocaleString()}</strong></p>
						<p style="margin: 4px 0;">Squares: <strong>${d.squarePoints.toLocaleString()}</strong></p>
						<p style="margin: 4px 0;">Placements: <strong>${d.placementPoints.toLocaleString()}</strong></p>
						<p style="margin: 4px 0;">Combo Bonus: <strong>${d.comboBonusPoints.toLocaleString()}</strong></p>
						<p style="margin: 4px 0;">Streak Bonus: <strong>${(d.streakBonusPoints||0).toLocaleString()}</strong></p>
						<p style="margin: 8px 0 4px 0; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.2); font-weight: bold; color: var(--primary-color, #3498db);">Total: <strong>${(d.linePoints+d.squarePoints+d.placementPoints+d.comboBonusPoints+(d.streakBonusPoints||0)).toLocaleString()}</strong></p>
					</div>
				</div>
				${e.petrificationStats&&this.enablePetrification?`
				<div style="margin-top: 12px; padding: 10px; background: rgba(150, 200, 255, 0.08); border: 1px solid rgba(150, 200, 255, 0.2); border-radius: 8px;">
					<h3 style="margin: 0 0 6px 0; color: #96c8ff; font-size: 1em;">â„ Petrification Stats</h3>
					<p style="margin: 4px 0;">Grid Cells Petrified: <strong>${e.petrificationStats.gridCellsPetrified||0}</strong></p>
					<p style="margin: 4px 0;">Blocks Petrified: <strong>${e.petrificationStats.blocksPetrified||0}</strong></p>
					<p style="margin: 4px 0;">Grid Cells Thawed: <strong>${e.petrificationStats.gridCellsThawed||0}</strong></p>
					<p style="margin: 4px 0;">Blocks Thawed: <strong>${e.petrificationStats.blocksThawed||0}</strong></p>
				</div>
				`:""}
			</div>
			<div style="margin-top: 18px; display: flex; justify-content: center; flex-wrap: wrap;">
				<button id="new-game-btn" style="margin: 5px; padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold;">
					New Game
				</button>
				<button id="share-score-btn" style="margin: 5px; padding: 12px 24px; background: var(--primary-color, #3498db); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold;">
					Share
				</button>
				<button id="close-modal-btn" style="margin: 5px; padding: 12px 24px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold;">
					Close
				</button>
			</div>
		`,s.appendChild(o),document.body.appendChild(s);const f=document.getElementById("new-game-btn"),b=document.getElementById("close-modal-btn"),v=document.getElementById("share-score-btn"),S=()=>{s.remove(),this.isGameOver=!1,this.newGame()},k=()=>{s.remove()};f.addEventListener("click",S),f.addEventListener("touchstart",p=>{p.preventDefault(),S()},{passive:!1}),b.addEventListener("click",k),b.addEventListener("touchstart",p=>{p.preventDefault(),k()},{passive:!1});const T=async()=>{var p,I;try{const x=((I=(p=e.difficulty)==null?void 0:p.toUpperCase)==null?void 0:I.call(p))||this.difficulty.toUpperCase(),B=window.location&&window.location.origin?window.location.origin+window.location.pathname:window.location.href||"",R=`Max Streak ${e.maxCombo}, Total Combos ${e.totalCombos||0}`,P=`I scored ${e.score} in Blockdoku (${x}) â€” Level ${e.level}, ${e.linesCleared} lines, ${R}!`;navigator.share?await navigator.share({title:"My Blockdoku Score",text:P,url:B}):navigator.clipboard&&navigator.clipboard.writeText?(await navigator.clipboard.writeText(`${P} ${B}`),alert("Share link copied to clipboard!")):window.prompt("Copy this to share:",`${P} ${B}`)}catch(x){console.error("Share failed:",x)}};v&&(v.addEventListener("click",T),v.addEventListener("touchstart",p=>{p.preventDefault(),T()},{passive:!1})),s.addEventListener("touchstart",p=>{p.preventDefault()},{passive:!1}),s.addEventListener("touchmove",p=>{p.preventDefault()},{passive:!1}),s.addEventListener("touchend",p=>{p.preventDefault()},{passive:!1})}getStats(){var i,o;const e=this.scoringSystem.getStats(),t=((o=(i=this.difficultyManager)==null?void 0:i.getScoreMultiplier)==null?void 0:o.call(i))||1,s=this.petrificationManager?this.petrificationManager.getStats():null;return{score:this.score,level:this.level,linesCleared:e.linesCleared,combo:e.combo,maxCombo:e.maxCombo,totalCombos:e.totalCombos,maxStreakCount:e.maxStreakCount,rowClears:e.rowClears,columnClears:e.columnClears,squareClears:e.squareClears,comboActivations:e.comboActivations,comboModesUsed:Array.from(this.comboModesUsed||[]),breakdown:e.breakdownBase,difficulty:this.difficulty,difficultyMultiplier:t,petrificationStats:s}}showHighScores(){const e=document.getElementById("high-scores-modal"),t=document.getElementById("high-scores-list"),s=document.getElementById("statistics-display"),i=this.getHighScores();i.length===0?t.innerHTML="<p>No high scores yet. Play a game to set your first record!</p>":t.innerHTML=i.map((a,l)=>`
                <div class="score-item">
                    <span class="rank">#${l+1}</span>
                    <span class="score-value">${a.score.toLocaleString()}</span>
                    <span class="score-details">${(a.difficulty||"normal").toUpperCase()} â€¢ Level ${a.level} â€¢ ${a.linesCleared} lines â€¢ ${a.date}</span>
                </div>
            `).join("");const o=this.getStatistics();s.innerHTML=`
            <div class="stat-item">
                <span class="stat-label">Games Played:</span>
                <span class="stat-value">${o.gamesPlayed}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Score:</span>
                <span class="stat-value">${o.totalScore.toLocaleString()}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Best Score:</span>
                <span class="stat-value">${o.bestScore.toLocaleString()}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Lines:</span>
                <span class="stat-value">${o.totalLinesCleared}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Max Combo:</span>
                <span class="stat-value">${o.maxCombo}</span>
            </div>
        `,e.style.display="block"}hideHighScores(){const e=document.getElementById("high-scores-modal");e.style.display="none"}loadHighScores(){const e=document.getElementById("high-scores-list"),t=document.getElementById("statistics-display");if(!e||!t)return;const s=this.getHighScores();s.length===0?e.innerHTML="<p>No high scores yet. Play a game to set your first record!</p>":e.innerHTML=s.map((o,a)=>`
                <div class="score-item">
                    <span class="rank">#${a+1}</span>
                    <span class="score-value">${o.score.toLocaleString()}</span>
                    <span class="score-details">Level ${o.level} â€¢ ${o.linesCleared} lines â€¢ Max Streak: ${o.maxCombo||0} â€¢ Total Combos: ${o.totalCombos||0} â€¢ ${o.date}</span>
                </div>
            `).join("");const i=this.getStatistics();t.innerHTML=`
            <div class="stat-item">
                <span class="stat-label">Games Played:</span>
                <span class="stat-value">${i.gamesPlayed}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Score:</span>
                <span class="stat-value">${i.totalScore.toLocaleString()}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Best Score:</span>
                <span class="stat-value">${i.bestScore.toLocaleString()}</span>
            </div>
            <div class="stat-item">
				<span class="stat-label">Total Lines:</span>
				<span class="stat-value">${i.totalLinesCleared}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Max Streak:</span>
                <span class="stat-value">${i.maxCombo}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Combos:</span>
                <span class="stat-value">${i.totalCombos||0}</span>
            </div>
        `}showDifficultyModal(){const e=document.getElementById("difficulty-modal");this.updateDifficultyUI(),e.style.display="block"}hideDifficultyModal(){const e=document.getElementById("difficulty-modal");e.style.display="none"}showSettingsModal(){console.log("showSettingsModal called");const e=document.getElementById("settings-modal");if(!e){console.error("Settings modal not found!");return}console.log("Settings modal found, showing..."),this.pwaInstallManager?(this.pwaInstallManager.createInstallButton(),this.pwaInstallManager.showInstallButton()):console.log("PWA Install Manager not available"),this.updateThemeUI(),this.updateDifficultyUI(),this.loadHighScores(),this.settingsManager&&this.settingsManager.refreshStatistics&&this.settingsManager.refreshStatistics(),e.style.display="block",console.log("Settings modal should now be visible")}hideSettingsModal(){const e=document.getElementById("settings-modal");e.style.display="none"}updateDifficultyUI(){document.querySelectorAll(".difficulty-option").forEach(e=>{e.classList.remove("selected"),e.dataset.difficulty===this.difficulty&&e.classList.add("selected")}),document.getElementById("enable-hints").checked=this.enableHints,document.getElementById("enable-timer").checked=this.enableTimer}async selectDifficulty(e){const t=this.score>0||this.board&&this.board.some(s=>s.some(i=>i===1));t&&!await this.confirmationDialog.show(`Changing difficulty to ${e.toUpperCase()} will reset your current game and you'll lose your progress. Are you sure you want to continue?`)||(this.difficulty=e,this.difficultyManager&&this.difficultyManager.setDifficulty(e),this.applyDifficultySettings(),this.updateDifficultyUI(),this.updateDifficultyButton(),this.saveSettings(),t&&(this.blockPalette&&this.blockPalette.resetDragState&&this.blockPalette.resetDragState(),this.newGame()))}selectTheme(e){this.gameRunning&&this.saveGameState(),this.blockPalette&&this.blockPalette.clearPlaceability&&this.blockPalette.clearPlaceability(),this.currentTheme=e,this.applyTheme(e),this.updateThemeUI(),this.saveSettings(),this.gameRunning&&(this.drawBoard(),setTimeout(()=>{this.updatePlaceabilityIndicators()},100))}updateThemeUI(){document.querySelectorAll(".theme-option").forEach(e=>{e.classList.remove("selected"),e.dataset.theme===this.currentTheme&&e.classList.add("selected")})}toggleSetting(e,t){switch(e){case"hints":this.enableHints=t;break;case"timer":this.enableTimer=t;break}this.saveSettings()}applyDifficultySettings(){switch(this.difficulty){case"easy":this.enableHints=!0,this.enableTimer=!1,this.moveLimit=null,this.timeLimit=null;break;case"normal":this.enableHints=!1,this.enableTimer=!1,this.moveLimit=null,this.timeLimit=null;break;case"hard":this.enableHints=!1,this.enableTimer=!1,this.moveLimit=50,this.timeLimit=null;break;case"expert":this.enableHints=!1,this.enableTimer=!0,this.moveLimit=30,this.timeLimit=300;break}}generateNewBlocks(){let e=3,t="all";switch(this.difficulty){case"easy":e=3,t="large";break;case"normal":e=3,t="all";break;case"hard":e=4,t="small";break;case"expert":e=5,t="complex";break}const s=this.blockManager.generateRandomBlocks(e,t,this.difficultyManager);this.blockPalette.updateBlocks(s),this.petrificationManager.updateBlockTracking(s),this.updatePlaceabilityIndicators(),this.updateBlockPointsDisplay(),this.autoSelectNextBlock()}placeBlock(e,t){if(!this.canPlaceBlock(e,t))return;this.board=this.blockManager.placeBlock(this.selectedBlock,e,t,this.board),this.petrificationManager.updateBoardTracking(this.board),this.scoringSystem.addPlacementPoints(this.scoringSystem.basePoints.single,this.difficultyManager.getScoreMultiplier());const s=this.scoringSystem.totalSpeedBonus;this.scoringSystem.recordPlacementTime();const i=this.scoringSystem.totalSpeedBonus-s;this.score=this.scoringSystem.getScore(),this.showPlacementPointsFeedback(this.scoringSystem.basePoints.single,e,t),i>0&&this.showSpeedBonusFeedback(i,e,t);const o=this.canvas.width/2,a=this.canvas.height/2;this.effectsManager.onBlockPlace(o,a),this.blockPalette.resetPieceTimeout(this.selectedBlock.id),this.blockPalette.resetDragState&&this.blockPalette.resetDragState(),this.petrificationManager.untrackBlock(this.selectedBlock.id),this.blockManager.removeBlock(this.selectedBlock.id),this.selectedBlock=null,this.previewPosition=null,this.blockPalette.updateBlocks(this.blockManager.currentBlocks),this.drawBoard(),this.updateUI(),this.updatePlaceabilityIndicators(),this.checkLineClears(),this.autoSave&&this.saveGameState(),this.blockManager.currentBlocks.length===0&&this.generateNewBlocks(),this.isGameOver||this.checkGameOver(),this.autoSelectNextBlock()}showSpeedBonusFeedback(e,t,s){if(!(this.storage.loadSettings().showSpeedBonus===!0))return;const a=this.cellSize,l=s*a+a/2,n=t*a+a/2,r=this.scoringSystem.getSpeedMode(),c=document.createElement("div");c.className="speed-bonus-text",r==="punishment"?c.textContent=`-${e} Too Fast!`:c.textContent=`+${e} Speed!`,c.style.cssText=`
            position: absolute;
            left: ${l}px;
            top: ${n}px;
            transform: translate(-50%, -50%);
            color: ${r==="punishment"?"#ff3333":"#ff6b35"};
            font-weight: 900;
            font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            pointer-events: none;
            z-index: 1000;
            animation: speedBonusFloat 1.5s ease-out forwards;
        `;const h=document.getElementById("board-overlay");h&&(h.appendChild(c),setTimeout(()=>{c.parentNode&&c.parentNode.removeChild(c)},1500)),this.effectsManager.onSpeedBonus(l,n,e)}resetStuckUIState(){console.log("Resetting stuck UI state..."),this.pendingClears=null,this.pendingClearResult=null,this.pendingClearsTimestamp=null,this.clearTimeoutId&&(clearTimeout(this.clearTimeoutId),this.clearTimeoutId=null),this.safetyTimeoutId&&(clearTimeout(this.safetyTimeoutId),this.safetyTimeoutId=null),this.drawBoard(),!this.blockManager.currentBlocks||this.blockManager.currentBlocks.length===0?(console.log("No blocks available, generating new blocks..."),this.generateNewBlocks()):(console.log("Refreshing existing blocks..."),this.blockPalette.updateBlocks(this.blockManager.currentBlocks)),this.updatePlaceabilityIndicators(),this.updateUI(),console.log("UI state reset complete")}checkGameOver(){if(this.board||(console.error("EMERGENCY: Board is undefined in checkGameOver, reinitializing..."),this.board=this.initializeBoard(),this.updatePlaceabilityIndicators()),!this.isInitialized||this.isGameOver||this.blockManager.currentBlocks.length===0)return;if(this.blockPalette.areAllPiecesTimedOut()){console.log("Game Over: All pieces timed out"),this.gameOver();return}const e=this.computePlaceabilityMap();if(Object.values(e).some(s=>s)){this.preGameOverPending=!1;return}this.preGameOverPending||(this.preGameOverPending=!0,this.blockPalette&&this.blockPalette.showPreGameOverIndicator&&this.blockPalette.showPreGameOverIndicator(1250),setTimeout(()=>{this.isGameOver||(!Object.values(this.computePlaceabilityMap()).some(i=>i)?this.gameOver():this.preGameOverPending=!1)},1250))}handlePieceTimeout(e){console.log("Piece timed out:",e),this.blockPalette.areAllPiecesTimedOut()&&setTimeout(()=>{this.isGameOver||(console.log("All pieces timed out - Game Over"),this.gameOver())},1e3)}updatePlaceabilityIndicators(){if(!this.blockManager||!this.blockPalette||!this.blockManager.currentBlocks||this.blockManager.currentBlocks.length===0)return;const e=this.computePlaceabilityMap(),t=Object.keys(e).filter(s=>e[s]);this.blockPalette.setPlaceability&&(t.length===1?this.blockPalette.setPlaceability(e,{highlightLast:!0,durationMs:0}):t.length===0?this.blockPalette.showPreGameOverIndicator(0):this.blockPalette.setPlaceability(e,{highlightLast:!1,durationMs:0}))}computePlaceabilityMap(){const e={};if(!this.blockManager||!this.blockManager.currentBlocks)return e;for(const t of this.blockManager.currentBlocks)e[t.id]=this.canPlaceAnywhere(t);return e}canPlaceAnywhere(e){for(let t=0;t<this.boardSize;t++)for(let s=0;s<this.boardSize;s++)if(this.blockManager.canPlaceBlock(e,t,s,this.board))return!0;return!1}}function D(){window.game=new he,window.resetStuckUI=function(){window.game&&window.game.resetStuckUIState?(window.game.resetStuckUIState(),console.log("Stuck UI state has been reset")):console.error("Game not initialized or resetStuckUIState method not available")},console.log("Global resetStuckUI() function available for debugging")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",D):D();
