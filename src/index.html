<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockdoku</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta name="theme-color" content="#8d6e63">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Blockdoku">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="stylesheet" href="css/main.css">
    <!-- Theme will be dynamically loaded by JavaScript -->
    <link rel="stylesheet" href="" id="theme-css">
    <!-- Preload other themes so we can switch reliably after build -->
    <link rel="stylesheet" href="css/themes/light.css" id="theme-css-light" media="not all">
    <link rel="stylesheet" href="css/themes/dark.css" id="theme-css-dark" media="not all">
    <link rel="stylesheet" href="css/themes/wood.css" id="theme-css-wood" media="not all">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="logo-container">
                <img src="assets/images/logo_transparent_bg.png" alt="Blockdoku" class="app-logo">
                <button id="new-game" class="btn btn-primary new-game-btn">New Game</button>
            </div>
            <div class="controls">
                <button id="difficulty-btn" class="btn btn-secondary difficulty-btn">Normal</button>
                <!-- Settings button navigates to separate settings.html page (not a modal) -->
                <button id="settings-toggle" class="btn btn-secondary">‚öôÔ∏è</button>
            </div>
        </header>
        
        <!-- SCORING BAR: Always visible score, level, and combo display -->
        <div class="game-info">
            <div class="score">
                <span>Score </span>
                <span id="score">0</span>
            </div>
            <div class="level">
                <span>Level </span>
                <span id="level">1</span>
            </div>
            <div class="combo">
                <span id="combo-label">Combo</span>
                <span id="combo">0</span>
            </div>
        </div>
        
        <!-- UTILITY BAR: Optional items controlled by gamesettings.html utility bar settings -->
        <div class="utility-bar" id="utility-bar">
            <!-- 4 potential utility items: hints, timer, personal best, speed timer -->
            <div class="utility-slot utility-slot-left">
                <div class="utility-item" id="hint-slot">
                    <div class="utility-item-content hint-controls" id="hint-controls" style="display: none;">
                        <button id="hint-btn" class="btn-hint">üí° Hint Off</button>
                    </div>
                </div>
            </div>
            
            <div class="utility-slot utility-slot-center">
                <div class="utility-item" id="timer-slot">
                    <div class="utility-item-content timer" id="timer-display" style="display: none;">
                        <span class="timer-label">TIME</span>
                        <span id="timer" class="timer-value">5:00</span>
                    </div>
                </div>
            </div>
            
            <div class="utility-slot utility-slot-center-right">
                <div class="utility-item" id="personal-best-slot">
                    <div class="utility-item-content personal-bests" id="personal-bests" style="display: none;">
                        <span class="pb-label">BEST</span>
                        <span class="pb-value" id="personal-best-value">0</span>
                    </div>
                </div>
            </div>
            
            <div class="utility-slot utility-slot-right">
                <div class="utility-item" id="speed-timer-slot">
                    <div class="utility-item-content speed-timer" id="speed-timer" style="display: none;">
                        <span class="speed-label">SPEED</span>
                        <span id="speed-timer-value" class="speed-value">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <main class="main">
            <div class="game-container">
                
                <div class="game-area">
                    <div class="game-board-container">
                        <canvas id="game-board" width="450" height="450"></canvas>
                        <div class="board-overlay" id="board-overlay"></div>
                    </div>
                </div>
                
                <div id="block-palette"></div>
            </div>
        </main>
        
        <footer class="footer">
            <p>Click on the board to place the selected block. Complete rows, columns, or 3x3 squares to score points!</p>
        </footer>
    </div>
    
    <!-- High Scores Modal -->
    <div id="high-scores-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>High Scores</h2>
                <button id="close-high-scores" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="high-scores-list"></div>
                <div class="statistics">
                    <h3>Statistics</h3>
                    <div id="statistics-display"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Difficulty Modal -->
    <div id="difficulty-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Difficulty Settings</h2>
                <button id="close-difficulty" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="difficulty-options">
                    <div class="difficulty-option" data-difficulty="easy">
                        <div class="difficulty-header">
                            <h3>Easy</h3>
                            <span class="difficulty-badge easy">EASY</span>
                        </div>
                        <p>Larger blocks, slower pace, hints available</p>
                        <ul>
                            <li>3x3 and 4x4 block shapes</li>
                            <li>Visual placement hints</li>
                            <li>No time pressure</li>
                            <li>Undo moves available</li>
                        </ul>
                    </div>
                    
                    <div class="difficulty-option" data-difficulty="normal">
                        <div class="difficulty-header">
                            <h3>Normal</h3>
                            <span class="difficulty-badge normal">NORMAL</span>
                        </div>
                        <p>Standard block variety, moderate pace</p>
                        <ul>
                            <li>Mixed block sizes (1x1 to 5x5)</li>
                            <li>Standard scoring</li>
                            <li>No time pressure</li>
                            <li>No hints</li>
                        </ul>
                    </div>
                    
                    <div class="difficulty-option" data-difficulty="hard">
                        <div class="difficulty-header">
                            <h3>Hard</h3>
                            <span class="difficulty-badge hard">HARD</span>
                        </div>
                        <p>Smaller blocks, faster pace, no hints</p>
                        <ul>
                            <li>Smaller block shapes (1x1 to 3x3)</li>
                            <li>Faster block generation</li>
                            <li>No placement hints</li>
                            <li>Limited moves</li>
                        </ul>
                    </div>
                    
                    <div class="difficulty-option" data-difficulty="expert">
                        <div class="difficulty-header">
                            <h3>Expert</h3>
                            <span class="difficulty-badge expert">EXPERT</span>
                        </div>
                        <p>Complex shapes, time pressure, limited moves</p>
                        <ul>
                            <li>Complex irregular shapes</li>
                            <li>Time pressure mode</li>
                            <li>Very limited moves</li>
                            <li>No hints or undo</li>
                        </ul>
                    </div>
                </div>
                
                <div class="difficulty-settings">
                    <h3>Additional Settings</h3>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="enable-hints" />
                            Enable placement hints
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="enable-timer" />
                            Enable time pressure
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="enable-undo" />
                            Enable undo moves
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button id="close-settings" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Theme Section -->
                    <div class="settings-section">
                        <h3>Theme</h3>
                        <div class="theme-options">
                            <button class="theme-option" data-theme="wood">
                                <span class="theme-preview wood-preview"></span>
                                <span>Wood</span>
                            </button>
                            <button class="theme-option" data-theme="light">
                                <span class="theme-preview light-preview"></span>
                                <span>Light</span>
                            </button>
                            <button class="theme-option" data-theme="dark">
                                <span class="theme-preview dark-preview"></span>
                                <span>Dark</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Difficulty Section -->
                    <div class="settings-section">
                        <h3>Difficulty</h3>
                        <div class="difficulty-options">
                            <button class="difficulty-option" data-difficulty="easy">
                                <div class="difficulty-header">
                                    <h4>Easy</h4>
                                    <span class="difficulty-badge easy">EASY</span>
                                </div>
                                <p>Larger blocks, slower pace, hints available</p>
                            </button>
                            <button class="difficulty-option" data-difficulty="normal">
                                <div class="difficulty-header">
                                    <h4>Normal</h4>
                                    <span class="difficulty-badge normal">NORMAL</span>
                                </div>
                                <p>Standard block variety, moderate pace</p>
                            </button>
                            <button class="difficulty-option" data-difficulty="hard">
                                <div class="difficulty-header">
                                    <h4>Hard</h4>
                                    <span class="difficulty-badge hard">HARD</span>
                                </div>
                                <p>Smaller blocks, faster pace, no hints</p>
                            </button>
                            <button class="difficulty-option" data-difficulty="expert">
                                <div class="difficulty-header">
                                    <h4>Expert</h4>
                                    <span class="difficulty-badge expert">EXPERT</span>
                                </div>
                                <p>Complex shapes, time pressure, limited moves</p>
                            </button>
                        </div>
                    </div>
                    
                    <!-- High Scores Section -->
                    <div class="settings-section">
                        <h3>High Scores</h3>
                        <div id="high-scores-list"></div>
                        <div class="statistics">
                            <h4>Statistics</h4>
                            <div id="statistics-display"></div>
                        </div>
                    </div>
                    
                    <!-- PWA Install Section -->
                    <div class="settings-section">
                        <h3>Install App</h3>
                        <p>Install Blockdoku as a Progressive Web App for a better experience:</p>
                        <div id="install-button-container">
                            <!-- Install button will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Copyright Notice -->
    <div class="copyright-notice">
        <p>&copy; Chase Pettet, <a href="http://523.life" target="_blank" rel="noopener noreferrer">523.life</a></p>
    </div>
    
    <script>
        // Function to update theme
        function updateTheme() {
            const savedSettings = localStorage.getItem('blockdoku_settings') || localStorage.getItem('blockdoku-settings');
            let theme = 'wood'; // Default to wood theme
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    if (settings.theme) {
                        theme = settings.theme;
                    }
                } catch (e) {
                    console.log('Error parsing settings:', e);
                }
            }
            
            console.log('Client-side theme update:', theme);
            
            // Handle Vite-injected theme links
            try {
                const builtWoodLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
                    .filter(l => (l.getAttribute('href') || '').includes('/assets/wood-') || (l.href || '').includes('/assets/wood-'));
                const builtLightLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
                    .filter(l => (l.getAttribute('href') || '').includes('/assets/light-') || (l.href || '').includes('/assets/light-'));
                const builtDarkLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
                    .filter(l => (l.getAttribute('href') || '').includes('/assets/dark-') || (l.href || '').includes('/assets/dark-'));
                
                // Disable all built theme links first
                [...builtWoodLinks, ...builtLightLinks, ...builtDarkLinks].forEach(l => {
                    l.disabled = true;
                });
                
                // Enable the correct built theme link
                if (theme === 'wood' && builtWoodLinks.length > 0) {
                    builtWoodLinks[0].disabled = false;
                    console.log('Enabled built wood theme');
                } else if (theme === 'light' && builtLightLinks.length > 0) {
                    builtLightLinks[0].disabled = false;
                    console.log('Enabled built light theme');
                } else if (theme === 'dark' && builtDarkLinks.length > 0) {
                    builtDarkLinks[0].disabled = false;
                    console.log('Enabled built dark theme');
                }
            } catch (e) {
                console.log('Error managing built theme links:', e);
            }
            
            // Manage preloaded theme links
            const preloadedThemes = ['light', 'dark', 'wood'];
            preloadedThemes.forEach(themeName => {
                const link = document.getElementById(`theme-css-${themeName}`);
                if (link) {
                    link.disabled = themeName !== theme;
                }
            });
            
            // Set the main theme-css link as fallback
            let themeLink = document.getElementById('theme-css');
            if (!themeLink) {
                themeLink = document.createElement('link');
                themeLink.rel = 'stylesheet';
                themeLink.id = 'theme-css';
                document.head.appendChild(themeLink);
            }
            themeLink.href = `css/themes/${theme}.css`;
            
            // Set data-theme attribute for CSS selectors
            document.documentElement.setAttribute('data-theme', theme);
            
            // Add theme class to body
            document.body.className = document.body.className.replace(/light-theme|dark-theme|wood-theme/g, '');
            document.body.classList.add(`${theme}-theme`);
        }
        
        // Load current theme from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure everything is loaded
            setTimeout(updateTheme, 100);
        });
        
        // Listen for theme changes from other pages
        window.addEventListener('storage', function(e) {
            if (e.key === 'blockdoku-settings' || e.key === 'blockdoku-settings') {
                updateTheme();
            }
        });
        
        // Also listen for focus events (when returning from main page)
        window.addEventListener('focus', function() {
            updateTheme();
        });
    </script>
    
    <script type="module" src="js/app.js"></script>
</body>
</html>
