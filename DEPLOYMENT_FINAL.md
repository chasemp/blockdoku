# Blockdoku PWA - Final Deployment Workflow

**Date:** October 3, 2025  
**Status:** ✅ Production Ready & Tested  
**Migration:** Completed Successfully

## 🎯 Quick Reference

### Daily Development
```bash
# 1. Edit files in /src
vim src/index.html

# 2. Test locally
npm run dev  # → http://localhost:3456

# 3. Commit (hook auto-builds /docs)
git add src/
git commit -m "Your changes"  # ← Tests run + /docs built automatically

# 4. Push
git push
```

**That's it!** The pre-commit hook handles everything else.

---

## 📁 Directory Structure (Final)

```
blockdoku_pwa/
├── src/                           # ✅ SOURCE - Edit here
│   ├── index.html
│   ├── settings.html
│   ├── gamesettings.html
│   ├── js/app.js
│   └── css/main.css
│
├── docs/                          # 🤖 BUILD OUTPUT - Auto-generated
│   ├── index.html                 # Built from src/index.html
│   ├── assets/                    # Bundled JS/CSS
│   ├── build                      # ⭐ Build version (quick ref)
│   ├── build-info.json            # ⭐ Build metadata (quick ref)
│   └── CNAME                      # Custom domain
│
├── public/                        # Static assets (copied to /docs)
│   ├── icons/
│   └── favicon.ico
│
├── .gitignore                     # Ignores /build, /build-info.json, /src/build-info.json
├── .gitattributes                 # Marks /docs as generated
├── .cursorrules                   # Warns AI about /docs
└── .git/hooks/pre-commit          # Auto-build + test hook
```

---

## 🔄 Complete Workflow

### What Happens on Commit

```bash
git commit -m "Update game logic"
```

**Pre-commit hook automatically:**
1. 🧪 Runs 20 critical regression tests
2. 🔨 Builds /src → /docs (via `npm run build`)
3. 📋 Copies `build` and `build-info.json` to `/docs/`
4. 📝 Adds "DO NOT EDIT" warnings to /docs HTML files
5. ➕ Stages all /docs changes (`git add docs/`)
6. ✅ Allows commit if all tests pass

**Result:** `/docs` is always up-to-date and working directory is clean ✅

---

## 🛠️ Build Metadata System

### Files (Final Solution)

| File | Location | Git Status | Purpose |
|------|----------|------------|---------|
| `build` | Root | ❌ Gitignored | Generated during build |
| `build-info.json` | Root | ❌ Gitignored | Generated during build |
| `src/build-info.json` | ❌ Removed | ❌ N/A | Not needed in source |
| **`docs/build`** | `/docs` | ✅ **Committed** | Quick version check for cache debugging |
| **`docs/build-info.json`** | `/docs` | ✅ **Committed** | Metadata for deployed app |

### Why This Design?

**Problem We Solved:**
- Root build files caused commit churn (timestamps changed every build)
- Made it impossible to have clean working directory after commits
- Created push/pull conflicts

**Solution:**
- Root build files are **generated but gitignored**
- Pre-commit hook **copies them to `/docs`**
- Only `/docs` versions are committed
- Result: Clean commits, no timestamp churn ✅

### Build Info Contents

```bash
# docs/build (plain text)
1.5.0+20251003-0856

# docs/build-info.json
{
  "version": "1.5.0",
  "buildId": "20251003-0856",
  "buildDate": "2025-10-03T13:56:00.000Z",
  "fullVersion": "1.5.0+20251003-0856"
}
```

**Usage:** Quick cache-busting verification without parsing bundled JS

---

## 🔐 Protection Layers

We have **4 layers** preventing accidental `/docs` edits:

### 1. `.gitattributes`
```
docs/** linguist-generated=true
docs/** text eol=lf
```
Marks files as generated in GitHub UI

### 2. `.cursorrules`
```
# CRITICAL: DO NOT EDIT FILES IN THE /docs DIRECTORY!
# Edit /src instead, then run 'npm run build'
```
Warns AI assistants

### 3. HTML Comments
```html
<!--
⚠️  AUTO-GENERATED FILE - DO NOT EDIT MANUALLY! ⚠️
This file was generated by Vite from /src
Edit /src/index.html and run 'npm run build'
-->
```
Warns human developers

### 4. Documentation
- `DEPLOYMENT.md` - Complete guide
- `QUICK_START.md` - One-page reference
- `PWA_LESSONS_LEARNED.md` - Lessons from migration

**Note:** We removed file-system read-only protection as it blocked git operations (pull, rebase, merge)

---

## 🧪 Pre-Commit Tests

Hook runs **20 critical regression tests** before every commit:

### Theme Tests (5)
- Theme change preserves difficulty
- All pages respect theme changes  
- Gamesettings theme synchronization
- Default theme consistency
- Cross-page theme updates

### Navigation Tests (2)
- Back buttons work between pages
- Settings page links correct

### Difficulty Tests (2)
- All difficulty modes work
- Hints only in Easy mode

### Storage Tests (2)
- Settings persistence
- Game state save/load

### Game Logic Tests (11)
- Block generation & rotation
- Scoring & line clearing
- PWA service worker
- UI initialization

**All must pass or commit is aborted** ✅

---

## 🚀 Deployment

### GitHub Pages Configuration

**Repository:** `chasemp/blockdoku`  
**Settings:** Settings → Pages

```
Source: Deploy from a branch
Branch: main
Folder: /docs
```

**Custom Domain:** `blockdoku.523.life`
- CNAME file: `/docs/CNAME`
- DNS: Points to GitHub Pages

### Deployment Timeline

```
git push → GitHub receives commit → ~1-2 minutes → Live at blockdoku.523.life
```

**No GitHub Actions needed** - GitHub Pages serves `/docs` directly

---

## ❌ Common Mistakes (And How We Prevent Them)

### Mistake 1: Editing /docs files directly
**Prevention:**
- ✅ `.cursorrules` warns AI
- ✅ HTML comments warn humans
- ✅ Documentation everywhere

### Mistake 2: Forgetting to build before commit
**Prevention:**
- ✅ Pre-commit hook auto-builds
- ✅ Can't forget!

### Mistake 3: /src and /docs out of sync
**Prevention:**
- ✅ Hook builds on every commit
- ✅ /docs always matches /src

### Mistake 4: Breaking theme/navigation during refactor
**Prevention:**
- ✅ 20 regression tests run automatically
- ✅ Commit blocked if tests fail

### Mistake 5: Build metadata causing commit churn
**Prevention:**
- ✅ Root build files gitignored
- ✅ Only /docs versions committed
- ✅ Working directory stays clean

---

## 🐛 Troubleshooting

### Issue: Pre-commit hook fails with "tests failed"
```bash
# See what's failing
node scripts/pre-commit-tests.js

# Fix the issue, then commit again
```

### Issue: Pre-commit hook fails with "build failed"
```bash
# Run build manually to see errors
npm run build

# Fix the issue, then commit again
```

### Issue: Live site doesn't match latest code
```bash
# Check if /docs is up to date
git status

# If /docs has uncommitted changes, something's wrong
# Rebuild manually
npm run build
git add docs/
git commit -m "Update /docs"
git push
```

### Issue: Git rebase/pull failing
```bash
# /docs should NOT be read-only
# If you see permission errors:
chmod -R u+w docs/

# Then retry your git operation
git pull --rebase origin main
```

---

## 📚 Related Documentation

- `QUICK_START.md` - One-page quick reference
- `PWA_LESSONS_LEARNED.md` - Lessons from this migration
- `DEPLOYMENT_MIGRATION_SUMMARY.md` - What changed and why
- `project-docs/` - Original project documentation (rescued)

---

## 🎉 Success Criteria

Your deployment workflow is working correctly if:

- ✅ You only edit files in `/src`
- ✅ `npm run dev` shows changes immediately
- ✅ Commits trigger tests + build automatically
- ✅ Working directory is clean after commits
- ✅ `git push` succeeds without conflicts
- ✅ Live site updates within 2 minutes
- ✅ No build file commit churn

**If all ✅ then you're good!** 🚀

---

**Created:** October 3, 2025  
**Last Updated:** October 3, 2025  
**Next Review:** As needed for future PWA projects


