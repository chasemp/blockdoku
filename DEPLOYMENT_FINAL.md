# Blockdoku PWA - Final Deployment Workflow

**Date:** October 3, 2025  
**Status:** âœ… Production Ready & Tested  
**Migration:** Completed Successfully

## ğŸ¯ Quick Reference

### Daily Development
```bash
# 1. Edit files in /src
vim src/index.html

# 2. Test locally
npm run dev  # â†’ http://localhost:3456

# 3. Commit (hook auto-builds /docs)
git add src/
git commit -m "Your changes"  # â† Tests run + /docs built automatically

# 4. Push
git push
```

**That's it!** The pre-commit hook handles everything else.

---

## ğŸ“ Directory Structure (Final)

```
blockdoku_pwa/
â”œâ”€â”€ src/                           # âœ… SOURCE - Edit here
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ settings.html
â”‚   â”œâ”€â”€ gamesettings.html
â”‚   â”œâ”€â”€ js/app.js
â”‚   â””â”€â”€ css/main.css
â”‚
â”œâ”€â”€ docs/                          # ğŸ¤– BUILD OUTPUT - Auto-generated
â”‚   â”œâ”€â”€ index.html                 # Built from src/index.html
â”‚   â”œâ”€â”€ assets/                    # Bundled JS/CSS
â”‚   â”œâ”€â”€ build                      # â­ Build version (quick ref)
â”‚   â”œâ”€â”€ build-info.json            # â­ Build metadata (quick ref)
â”‚   â””â”€â”€ CNAME                      # Custom domain
â”‚
â”œâ”€â”€ public/                        # Static assets (copied to /docs)
â”‚   â”œâ”€â”€ icons/
â”‚   â””â”€â”€ favicon.ico
â”‚
â”œâ”€â”€ .gitignore                     # Ignores /build, /build-info.json, /src/build-info.json
â”œâ”€â”€ .gitattributes                 # Marks /docs as generated
â”œâ”€â”€ .cursorrules                   # Warns AI about /docs
â””â”€â”€ .git/hooks/pre-commit          # Auto-build + test hook
```

---

## ğŸ”„ Complete Workflow

### What Happens on Commit

```bash
git commit -m "Update game logic"
```

**Pre-commit hook automatically:**
1. ğŸ§ª Runs 20 critical regression tests
2. ğŸ”¨ Builds /src â†’ /docs (via `npm run build`)
3. ğŸ“‹ Copies `build` and `build-info.json` to `/docs/`
4. ğŸ“ Adds "DO NOT EDIT" warnings to /docs HTML files
5. â• Stages all /docs changes (`git add docs/`)
6. âœ… Allows commit if all tests pass

**Result:** `/docs` is always up-to-date and working directory is clean âœ…

---

## ğŸ› ï¸ Build Metadata System

### Files (Final Solution)

| File | Location | Git Status | Purpose |
|------|----------|------------|---------|
| `build` | Root | âŒ Gitignored | Generated during build |
| `build-info.json` | Root | âŒ Gitignored | Generated during build |
| `src/build-info.json` | âŒ Removed | âŒ N/A | Not needed in source |
| **`docs/build`** | `/docs` | âœ… **Committed** | Quick version check for cache debugging |
| **`docs/build-info.json`** | `/docs` | âœ… **Committed** | Metadata for deployed app |

### Why This Design?

**Problem We Solved:**
- Root build files caused commit churn (timestamps changed every build)
- Made it impossible to have clean working directory after commits
- Created push/pull conflicts

**Solution:**
- Root build files are **generated but gitignored**
- Pre-commit hook **copies them to `/docs`**
- Only `/docs` versions are committed
- Result: Clean commits, no timestamp churn âœ…

### Build Info Contents

```bash
# docs/build (plain text)
1.5.0+20251003-0856

# docs/build-info.json
{
  "version": "1.5.0",
  "buildId": "20251003-0856",
  "buildDate": "2025-10-03T13:56:00.000Z",
  "fullVersion": "1.5.0+20251003-0856"
}
```

**Usage:** Quick cache-busting verification without parsing bundled JS

---

## ğŸ” Protection Layers

We have **4 layers** preventing accidental `/docs` edits:

### 1. `.gitattributes`
```
docs/** linguist-generated=true
docs/** text eol=lf
```
Marks files as generated in GitHub UI

### 2. `.cursorrules`
```
# CRITICAL: DO NOT EDIT FILES IN THE /docs DIRECTORY!
# Edit /src instead, then run 'npm run build'
```
Warns AI assistants

### 3. HTML Comments
```html
<!--
âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT MANUALLY! âš ï¸
This file was generated by Vite from /src
Edit /src/index.html and run 'npm run build'
-->
```
Warns human developers

### 4. Documentation
- `DEPLOYMENT.md` - Complete guide
- `QUICK_START.md` - One-page reference
- `PWA_LESSONS_LEARNED.md` - Lessons from migration

**Note:** We removed file-system read-only protection as it blocked git operations (pull, rebase, merge)

---

## ğŸ§ª Pre-Commit Tests

Hook runs **20 critical regression tests** before every commit:

### Theme Tests (5)
- Theme change preserves difficulty
- All pages respect theme changes  
- Gamesettings theme synchronization
- Default theme consistency
- Cross-page theme updates

### Navigation Tests (2)
- Back buttons work between pages
- Settings page links correct

### Difficulty Tests (2)
- All difficulty modes work
- Hints only in Easy mode

### Storage Tests (2)
- Settings persistence
- Game state save/load

### Game Logic Tests (11)
- Block generation & rotation
- Scoring & line clearing
- PWA service worker
- UI initialization

**All must pass or commit is aborted** âœ…

---

## ğŸš€ Deployment

### GitHub Pages Configuration

**Repository:** `chasemp/blockdoku`  
**Settings:** Settings â†’ Pages

```
Source: Deploy from a branch
Branch: main
Folder: /docs
```

**Custom Domain:** `blockdoku.523.life`
- CNAME file: `/docs/CNAME`
- DNS: Points to GitHub Pages

### Deployment Timeline

```
git push â†’ GitHub receives commit â†’ ~1-2 minutes â†’ Live at blockdoku.523.life
```

**No GitHub Actions needed** - GitHub Pages serves `/docs` directly

---

## âŒ Common Mistakes (And How We Prevent Them)

### Mistake 1: Editing /docs files directly
**Prevention:**
- âœ… `.cursorrules` warns AI
- âœ… HTML comments warn humans
- âœ… Documentation everywhere

### Mistake 2: Forgetting to build before commit
**Prevention:**
- âœ… Pre-commit hook auto-builds
- âœ… Can't forget!

### Mistake 3: /src and /docs out of sync
**Prevention:**
- âœ… Hook builds on every commit
- âœ… /docs always matches /src

### Mistake 4: Breaking theme/navigation during refactor
**Prevention:**
- âœ… 20 regression tests run automatically
- âœ… Commit blocked if tests fail

### Mistake 5: Build metadata causing commit churn
**Prevention:**
- âœ… Root build files gitignored
- âœ… Only /docs versions committed
- âœ… Working directory stays clean

---

## ğŸ› Troubleshooting

### Issue: Pre-commit hook fails with "tests failed"
```bash
# See what's failing
node scripts/pre-commit-tests.js

# Fix the issue, then commit again
```

### Issue: Pre-commit hook fails with "build failed"
```bash
# Run build manually to see errors
npm run build

# Fix the issue, then commit again
```

### Issue: Live site doesn't match latest code
```bash
# Check if /docs is up to date
git status

# If /docs has uncommitted changes, something's wrong
# Rebuild manually
npm run build
git add docs/
git commit -m "Update /docs"
git push
```

### Issue: Git rebase/pull failing
```bash
# /docs should NOT be read-only
# If you see permission errors:
chmod -R u+w docs/

# Then retry your git operation
git pull --rebase origin main
```

---

## ğŸ“š Related Documentation

- `QUICK_START.md` - One-page quick reference
- `PWA_LESSONS_LEARNED.md` - Lessons from this migration
- `DEPLOYMENT_MIGRATION_SUMMARY.md` - What changed and why
- `project-docs/` - Original project documentation (rescued)

---

## ğŸ‰ Success Criteria

Your deployment workflow is working correctly if:

- âœ… You only edit files in `/src`
- âœ… `npm run dev` shows changes immediately
- âœ… Commits trigger tests + build automatically
- âœ… Working directory is clean after commits
- âœ… `git push` succeeds without conflicts
- âœ… Live site updates within 2 minutes
- âœ… No build file commit churn

**If all âœ… then you're good!** ğŸš€

---

**Created:** October 3, 2025  
**Last Updated:** October 3, 2025  
**Next Review:** As needed for future PWA projects


